<!--
    PARSER DE TRADES - Sistema de Registro y An√°lisis de Operaciones
    
    Este parser permite procesar y registrar operaciones de trading de manera estructurada.
    Funcionalidades principales:
    
    1. DETECCI√ìN DE TRADES: Parsea datos en bruto de la plataforma (formato Funding) y detecta
       autom√°ticamente las operaciones, agrupando posiciones relacionadas cuando es necesario.
    
    2. COMPLETADO DE DATOS: Permite completar informaci√≥n adicional del trade como:
       - N√∫mero de trade, bloque
       - Stop Loss y Take Profit
       - Riesgo planeado vs ejecutado
       - Setup utilizado (Item)
       - Observaciones y cumplimiento del plan diario
    
    3. C√ÅLCULOS AUTOM√ÅTICOS: Calcula m√©tricas importantes como:
       - Riesgo ejecutado (basado en stop loss y volumen)
       - Desviaci√≥n del riesgo planeado
       - Valores R (R planeado y R ejecutado)
    
    4. GUARDADO Y EXPORTACI√ìN: Guarda los trades en storage y genera:
       - Plantilla para Telegram
       - L√≠nea CSV para exportaci√≥n
    
    5. QUICK ADD: Permite registro r√°pido de trades durante el mercado (solo symbol y P&L)
       para completar despu√©s con todos los detalles.
    
    El sistema valida contra el plan diario y previene duplicados bas√°ndose en Order IDs.
-->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Parser</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy-dark': '#1e3a5f',
                        'navy-medium': '#2c5282',
                        'blue-primary': '#3b5998',
                        'blue-hover': '#2d4373',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .processing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Step indicator */
        .step-active {
            background: #3b5998;
            color: white;
        }

        .step-completed {
            background: #10b981;
            color: white;
        }

        .step-inactive {
            background: #e2e8f0;
            color: #64748b;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-navy-dark text-white px-6 py-3 flex justify-between items-center shadow-lg no-print">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-bold">TRADE PARSER</h1>
            <div class="flex gap-4 text-sm">
                <a href="daily-plan.html" class="hover:text-blue-300 transition-colors">üìã Daily Plan</a>
                <a href="parser.html" class="text-blue-300 font-semibold">‚öôÔ∏è Parser</a>
                <a href="dashboard.html" class="hover:text-blue-300 transition-colors">üìä Dashboard</a>
            </div>
        </div>
        <div class="text-sm text-slate-300" id="current-date"></div>
    </nav>

    <!-- Status Message -->
    <div id="status-message" class="hidden slide-in max-w-7xl mx-auto mt-4 px-4">
        <!-- Content injected via JS -->
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-4 py-6">

        <!-- Quick Add Button (Prominent) -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-lg shadow-xl mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-white mb-2">‚ö° Quick Add Trade</h2>
                    <p class="text-white/90 text-sm">Registro r√°pido durante el mercado (5 segundos)</p>
                </div>
                <button onclick="openQuickAddModal()"
                        class="bg-white text-green-600 px-8 py-4 rounded-lg font-bold text-lg hover:bg-green-50 transition-all shadow-lg">
                    ‚ö° Add Quick
                </button>
            </div>
        </div>

        <!-- Quick Adds Pendientes -->
        <div id="quickAddsPending" class="hidden bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-yellow-900">üìù Quick Adds Pendientes (<span id="qa-pending-count">0</span>)</h3>
                <button onclick="completeAllQuickAdds()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                    Completar Todos
                </button>
            </div>
            <div id="qa-pending-list" class="space-y-3">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- ============================================ -->
        <!-- MAIN CONTENT: Parser Steps -->
        <!-- ============================================ -->
        <div class="space-y-6">

                <!-- Step Indicator -->
                <div class="bg-white rounded-lg shadow-lg border border-slate-200 p-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div
                                class="step-active w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                1</div>
                            <span class="text-sm font-medium text-slate-700">Pegar Datos</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                2</div>
                            <span class="text-sm font-medium text-slate-700">Detectar</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                3</div>
                            <span class="text-sm font-medium text-slate-700">Completar</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                4</div>
                            <span class="text-sm font-medium text-slate-700">Guardar</span>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- STEP 1: Paste Data -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200" id="step-1">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">üìä Paso 1: Pegar Datos
                            de la Plataforma</h3>
                    </div>

                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                Pega aqu√≠ los datos del trade (Formato Funding):
                            </label>
                            <textarea id="raw-data" rows="12" placeholder="Ejemplo:
323002810	2024-10-28 19:59:17	SOLUSD	Short	197.96	196.13	1.83	12	21.96	Funding"
                                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent font-mono text-sm resize-none"></textarea>
                            <p class="text-xs text-slate-500 mt-2">
                                üí° Formato esperado: Order ID, Time (UTC), Symbol, Side, Entry, Exit, PnL per unit,
                                Volume, PnL total, Type
                            </p>
                        </div>

                        <div class="flex justify-between items-center">
                            <button onclick="clearRawData()"
                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                                üîÑ Limpiar
                            </button>

                            <button onclick="detectTrades()"
                                class="px-6 py-2.5 bg-blue-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-hover transition-all shadow-lg">
                                üîç Detectar Trades ‚Üí
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 2: Detection Results (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-2">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">üîç Paso 2: Trades
                            Detectados</h3>
                    </div>

                    <div class="p-6" id="detection-results">
                        <!-- Populated via JS -->
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 3: Complete Trade Data (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-3">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">‚úçÔ∏è Paso 3: Completar
                            Datos del Trade</h3>
                    </div>

                    <div class="p-6">
                        <form id="trade-form" class="space-y-6">

                            <!-- Trade Number and Block -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="trade-number" class="block text-sm font-medium text-slate-700 mb-2">
                                        Trade Number <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" id="trade-number" name="tradeNumber" required
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                    <p class="text-xs text-slate-500 mt-1" id="trade-number-hint"></p>
                                </div>

                                <div>
                                    <label for="block" class="block text-sm font-medium text-slate-700 mb-2">
                                        Block
                                    </label>
                                    <input type="number" id="block" name="block" value="1"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                </div>
                            </div>

                            <!-- Stop Loss and Take Profit (Dynamic based on trade type) -->
                            <div id="stop-loss-container">
                                <!-- Will be filled dynamically by renderStopLossInputs() -->
                            </div>

                            <!-- Take Profit -->
                            <div>
                                <label for="take-profit" class="block text-sm font-medium text-slate-700 mb-2">
                                    Take Profit <span class="text-slate-400 text-xs">(opcional)</span>
                                </label>
                                <input type="number" step="0.01" id="take-profit" name="takeProfit"
                                    placeholder="0.00"
                                    oninput="updateCalculationPreview()"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                <p class="text-xs text-slate-500 mt-1">
                                    üí° Auto-relleno con exit price. Modif√≠calo si es necesario.
                                </p>
                            </div>

                            <!-- Planned Risk -->
                            <div>
                                <label for="risk-planned" class="block text-sm font-medium text-slate-700 mb-2">
                                    Riesgo Planeado <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-slate-400">$</span>
                                    <input type="number" step="0.01" id="risk-planned" name="riskPlanned" required
                                        placeholder="100.00"
                                        oninput="updateCalculationPreview()"
                                        class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Riesgo que planeaste antes de entrar al trade
                                </p>
                            </div>

                            <!-- Item (Setup) -->
                            <div>
                                <label for="item" class="block text-sm font-medium text-slate-700 mb-2">
                                    √çtem (Setup)
                                </label>
                                <input type="text" id="item" name="item"
                                    placeholder="e.g. Setup limpio, Reversi√≥n en soporte"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                            </div>

                            <!-- Observation -->
                            <div>
                                <label for="observation" class="block text-sm font-medium text-slate-700 mb-2">
                                    üí≠ Observaciones Generales
                                </label>
                                <textarea id="observation" name="observation" rows="3"
                                    placeholder="Notas sobre el trade, contexto del mercado, emociones..."
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent resize-none"></textarea>
                            </div>

                            <!-- What Went Well -->
                            <div>
                                <label for="what-went-well" class="block text-sm font-bold text-green-700 mb-2">
                                    ‚úÖ ¬øQu√© sali√≥ bien?
                                </label>
                                <textarea id="what-went-well" name="whatWentWell" rows="3"
                                    placeholder="Aspectos positivos de la ejecuci√≥n del trade..."
                                    class="w-full px-4 py-2 border-2 border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"></textarea>
                            </div>

                            <!-- What Went Wrong -->
                            <div>
                                <label for="what-went-wrong" class="block text-sm font-bold text-red-700 mb-2">
                                    ‚ùå ¬øQu√© sali√≥ mal?
                                </label>
                                <textarea id="what-went-wrong" name="whatWentWrong" rows="3"
                                    placeholder="Errores cometidos, √°reas de mejora..."
                                    class="w-full px-4 py-2 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"></textarea>
                            </div>

                            <!-- Plan Compliance -->
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                <h4 class="text-sm font-semibold text-slate-700 mb-3">Cumplimiento del Plan</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="followed-plan" name="followedPlan" checked
                                            class="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-500">
                                        <span class="text-sm text-slate-700">‚úÖ Segu√≠ el plan</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="broke-rules" name="brokeRules"
                                            onchange="toggleBrokeRulesNotes()"
                                            class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                                        <span class="text-sm text-slate-700">‚ùå Romp√≠ reglas</span>
                                    </label>
                                </div>
                                <div id="rules-violated-container" class="mt-3 hidden">
                                    <label class="block text-xs font-medium text-slate-700 mb-2">¬øQu√© reglas
                                        rompiste?</label>
                                    <textarea id="rules-violated" name="rulesViolated" rows="2"
                                        placeholder="Especifica qu√© reglas no seguiste..."
                                        class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-primary resize-none"></textarea>
                                </div>
                            </div>

                            <!-- Calculated Metrics Preview -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3">üìä M√©tricas Calculadas (Preview)
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                    <div>
                                        <p class="text-blue-700 font-medium">Riesgo Ejecutado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-risk-executed">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">Desviaci√≥n</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-risk-deviation">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">R Planeado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-r-planned">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">R Ejecutado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-r-executed">--</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Local Error Message (hidden by default) -->
                            <div id="form-error-message" class="hidden mb-4 slide-in"></div>

                            <!-- Action Buttons -->
                            <div class="flex justify-between items-center pt-4 border-t border-slate-200">
                                <button type="button" onclick="goBackToDetection()"
                                    class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                                    ‚Üê Volver
                                </button>

                                <button type="submit"
                                    class="px-6 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-all shadow-lg">
                                    üíæ Guardar Trade
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 4: Success & Outputs (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-4">
                    <div class="bg-green-50 px-6 py-3 border-b border-green-200">
                        <h3 class="font-semibold text-green-800 uppercase text-sm tracking-wide">‚úÖ Trade Guardado
                            Exitosamente</h3>
                    </div>

                    <div class="p-6 space-y-6">

                        <!-- Telegram Template -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">üì± Plantilla
                                Telegram:</label>
                            <div class="bg-slate-50 border border-slate-300 rounded-lg p-4 font-mono text-sm">
                                <pre id="telegram-output" class="whitespace-pre-wrap text-slate-800"></pre>
                            </div>
                            <button onclick="copyToClipboard('telegram-output')"
                                class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-all">
                                üìã Copiar
                            </button>
                        </div>

                        <!-- CSV Line -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">üìÑ L√≠nea CSV:</label>
                            <div
                                class="bg-slate-50 border border-slate-300 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                                <pre id="csv-output" class="whitespace-nowrap text-slate-800"></pre>
                            </div>
                            <button onclick="copyToClipboard('csv-output')"
                                class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-all">
                                üìã Copiar
                            </button>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-center gap-4 pt-4 border-t border-slate-200">
                            <button onclick="resetParser()"
                                class="px-6 py-2.5 bg-blue-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-hover transition-all">
                                ‚ûï Registrar Otro Trade
                            </button>
                            <a href="dashboard.html"
                                class="px-6 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-all inline-block">
                                üìä Ver Dashboard
                            </a>
                        </div>
                    </div>
                </section>

        </div>
    </div>

    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    <script>
        // ==========================================
        // IMPORT STORAGE MANAGER
        // ==========================================
        // Import Storage Manager
        const script = document.createElement('script');
        script.src = './storage.js';
        script.onload = () => {
            console.log('Storage Manager loaded');
            initializeQuickAdd();
        };
        document.head.appendChild(script);

        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            timezone: 'America/Sao_Paulo', // BRT
            storageKeys: {
                trades: 'trades-data',
                dailyPlan: 'daily-plan-today'
            }
        };

        // Global state
        let detectedTrades = [];
        let currentTrade = null;
        let dailyPlan = null;

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.addEventListener('DOMContentLoaded', async function () {
            setCurrentDate();
            await loadDailyPlan();
            setupEventListeners();

            console.log('‚úÖ Parser initialized');
        });

        function setCurrentDate() {
            const today = new Date();
            const options = {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric',
                timeZone: CONFIG.timezone
            };
            const dateStr = today.toLocaleDateString('en-US', options);
            document.getElementById('current-date').textContent = dateStr;
        }

        // ==========================================
        // LOAD DAILY PLAN
        // ==========================================
        async function loadDailyPlan() {
            try {
                const result = await window.storage.get(CONFIG.storageKeys.dailyPlan);

                if (result && result.value) {
                    dailyPlan = JSON.parse(result.value);
                    renderPlanSummary(dailyPlan);
                } else {
                    renderNoPlan();
                }
            } catch (error) {
                console.error('Error loading daily plan:', error);
                renderNoPlan();
            }
        }

        function renderPlanSummary(plan) {
            const container = document.getElementById('plan-summary');

            container.innerHTML = `
        <div class="space-y-3">
          <div class="pb-3 border-b border-slate-200">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Setup del d√≠a</p>
            <p class="text-sm text-slate-700 leading-snug">${plan.aSetup || 'No definido'}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
              <p class="text-xs text-slate-500 font-medium">Max Trades</p>
              <p class="text-lg font-bold text-slate-800">${plan.maxTrades || '5'}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500 font-medium">Max Loss</p>
              <p class="text-lg font-bold text-slate-800">$${plan.maxDailyLoss || '250'}</p>
            </div>
          </div>
          
          <div class="bg-amber-50 border border-amber-200 rounded p-3">
            <p class="text-xs font-semibold text-amber-900 mb-2">‚ö†Ô∏è Circuit Breakers</p>
            <div class="space-y-1 text-xs text-amber-800">
              ${plan.circuitBreakers?.twoLosses ? '<p>‚úì 2 losses = 30min break</p>' : ''}
              ${plan.circuitBreakers?.threeLosses ? '<p>‚úì 3 losses = done for day</p>' : ''}
              ${plan.circuitBreakers?.maxHit ? '<p>‚úì Max hit = close all</p>' : ''}
            </div>
          </div>
          
          <div class="pt-3 border-t border-slate-200">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Estado Mental</p>
            <p class="text-sm font-medium text-slate-700">${plan.mentalState || 'No registrado'}</p>
          </div>
        </div>
      `;
        }

        function renderNoPlan() {
            const container = document.getElementById('plan-summary');
            container.innerHTML = `
        <div class="text-center py-6">
          <p class="text-sm text-slate-500 mb-3">‚ö†Ô∏è No hay plan para hoy</p>
          <a href="daily-plan.html" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
            Crear plan ‚Üí
          </a>
        </div>
      `;
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            // Note: Broke rules toggle and calculation inputs now use inline onchange handlers
            // This ensures they work immediately without waiting for setupEventListeners

            // Form submission
            document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
        }

        // ==========================================
        // STEP 1: CLEAR RAW DATA
        // ==========================================
        function clearRawData() {
            document.getElementById('raw-data').value = '';
            showMessage('Textarea limpiado', 'info');
        }

        // ==========================================
        // STEP 2: DETECT TRADES
        // ==========================================
        async function detectTrades() {
            const rawData = document.getElementById('raw-data').value.trim();

            if (!rawData) {
                showMessage('Por favor pega los datos del trade primero', 'warning');
                return;
            }

            showMessage('üîç Detectando trades...', 'info');
            updateStepIndicator(2);

            try {
                // Parse all positions
                const allPositions = parseRawData(rawData);

                if (allPositions.length === 0) {
                    throw new Error('No se detectaron posiciones v√°lidas');
                }

                // Group positions into trades
                detectedTrades = groupPositions(allPositions);

                if (detectedTrades.length === 0) {
                    throw new Error('No se pudieron agrupar las posiciones');
                }

                // Show detection results
                renderDetectionResults(detectedTrades);

                // Show step 2
                document.getElementById('step-2').classList.remove('hidden');
                document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });

                const totalPositions = allPositions.length;
                const groupedCount = detectedTrades.filter(t => t.isGrouped).length;

                if (groupedCount > 0) {
                    showMessage(`‚úÖ ${detectedTrades.length} trade(s) detectado(s) de ${totalPositions} posici√≥n(es) - ${groupedCount} agrupado(s)`, 'success');
                } else {
                    showMessage(`‚úÖ ${detectedTrades.length} trade(s) detectado(s)`, 'success');
                }

            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        function parseRawData(rawData) {
            const lines = rawData.split('\n').filter(l => l.trim());

            if (lines.length === 0) return [];

            // Detect format type
            const formatType = detectFormatType(lines);
            console.log('Detected format:', formatType);

            if (formatType === 'table') {
                return parseTableFormat(lines);
            } else {
                return parseFundingFormat(lines);
            }
        }

        /**
         * Detect if input is Table format or Funding format
         */
        function detectFormatType(lines) {
            const firstLine = lines[0].trim();
            const parts = firstLine.split(/\t+|\s{2,}/);

            // Table format characteristics:
            // - Has 8+ columns
            // - Column 4 contains "Opening" or "Closing"
            // - Symbol is first column (letters only like ETHUSD, BTCUSD)

            if (parts.length >= 8) {
                const hasOpeningClosing = parts.some(p =>
                    p.toLowerCase().includes('opening') ||
                    p.toLowerCase().includes('closing')
                );

                const firstColIsSymbol = /^[A-Z]+$/.test(parts[0].replace(/[^A-Z]/g, ''));

                if (hasOpeningClosing && firstColIsSymbol) {
                    return 'table';
                }
            }

            // Default to funding format
            return 'funding';
        }

        /**
         * Parse broker table format
         * Columns: Symbol, DateTime, OrderID, Side, Position, Volume, Price, P&L, [extras...]
         */
        function parseTableFormat(lines) {
            const positions = [];
            let currentTrade = null;

            for (const line of lines) {
                const parts = line.trim().split(/\t+|\s{2,}/);

                // Only use columns 0-7, ignore rest
                if (parts.length < 8) {
                    console.warn('Table line ignored (too few columns):', line);
                    continue;
                }

                try {
                    const [
                        symbolRaw,     // 0: Symbol
                        dateTime,      // 1: Date/Time (e.g., 04/11/25 00.34)
                        orderID,       // 2: Order ID
                        tradeSide,     // 3: Side (Buy/Sell)
                        posEffect,     // 4: Position (Opening/Closing)
                        volumeRaw,     // 5: Trade Vol
                        priceRaw,      // 6: Trade Price
                        pnlRaw         // 7: P&L
                        // Ignore columns 8+
                    ] = parts;

                    // Clean and parse values
                    const symbol = symbolRaw.replace(/[^A-Z]/g, '').toUpperCase();
                    const volume = parseFloat(volumeRaw.replace(/[,']/g, ''));
                    const price = parseFloat(priceRaw.replace(/[,']/g, ''));
                    const pnl = parseFloat(pnlRaw.replace(/[,']/g, ''));

                    if (!symbol || isNaN(volume) || isNaN(price)) {
                        console.warn('Invalid data in table line:', line);
                        continue;
                    }

                    const isOpening = posEffect.toLowerCase().includes('opening');
                    const isClosing = posEffect.toLowerCase().includes('closing');

                    // Parse date/time (format: DD/MM/YY HH.MM)
                    const timeBRT = parseTableDateTime(dateTime);

                    if (isOpening) {
                        // Start new trade
                        currentTrade = {
                            orderID: orderID,
                            symbol: symbol,
                            side: tradeSide,
                            entry: price,
                            volume: volume,
                            timeBRT: timeBRT,
                            timeUTC: timeBRT, // Simplified for now
                            openHourBRT: new Date(timeBRT).getHours(),
                            pnl: 0
                        };
                    } else if (isClosing && currentTrade) {
                        // Complete the trade
                        currentTrade.exit = price;
                        currentTrade.pnl = pnl;
                        currentTrade.pnlPerUnit = pnl / volume;

                        // Determine LONG/SHORT
                        const isBuy = tradeSide.toLowerCase().includes('buy');
                        const isSell = tradeSide.toLowerCase().includes('sell');
                        currentTrade.type = isBuy ? 'SHORT' : 'LONG'; // Closing side determines type

                        positions.push(currentTrade);
                        currentTrade = null;
                    }

                } catch (error) {
                    console.warn('Error parsing table line:', line, error);
                }
            }

            return positions;
        }

        /**
         * Parse date/time from table format (DD/MM/YY HH.MM)
         */
        function parseTableDateTime(dateTimeStr) {
            try {
                // Format: "04/11/25 00.34"
                const [datePart, timePart] = dateTimeStr.trim().split(/\s+/);
                const [day, month, year] = datePart.split('/');
                const [hour, minute] = timePart.split('.');

                const fullYear = 2000 + parseInt(year);
                const date = new Date(fullYear, parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute));

                return date.toISOString().slice(0, 19).replace('T', ' ');
            } catch (error) {
                console.error('Error parsing table date:', dateTimeStr, error);
                return new Date().toISOString().slice(0, 19).replace('T', ' ');
            }
        }

        /**
         * Parse original Funding format (backwards compatibility)
         */
        function parseFundingFormat(lines) {
            const positions = [];

            for (const line of lines) {
                // Split by tab or multiple spaces
                const parts = line.split(/\t+|\s{2,}/);

                if (parts.length < 9) {
                    console.warn('Funding line ignored (formato inv√°lido):', line);
                    continue;
                }

                try {
                    const position = {
                        orderID: parts[0].trim(),
                        timeUTC: parts[1].trim(),
                        symbol: parts[2].trim(),
                        side: parts[3].trim(),
                        entry: parseFloat(parts[4]),
                        exit: parseFloat(parts[5]),
                        pnlPerUnit: parseFloat(parts[6]),
                        volume: parseFloat(parts[7]) || 0,
                        pnl: parseFloat(parts[8]),
                        rawType: parts[9] ? parts[9].trim() : 'Funding'
                    };

                    // Convert UTC to BRT
                    const utcDate = new Date(position.timeUTC.replace(' ', 'T') + 'Z');
                    const brtDate = new Date(utcDate.toLocaleString('en-US', { timeZone: CONFIG.timezone }));

                    position.timeBRT = brtDate.toISOString().slice(0, 19).replace('T', ' ');
                    position.openHourBRT = brtDate.getHours();

                    // Determine LONG/SHORT
                    position.type = position.side.toLowerCase().includes('long') ? 'LONG' : 'SHORT';

                    positions.push(position);

                } catch (error) {
                    console.warn('Error parseando funding line:', line, error);
                }
            }

            return positions;
        }

        // ==========================================
        // GROUPING LOGIC (v2.0)
        // ==========================================
        function groupPositions(positions) {
            if (positions.length === 0) return [];

            const trades = [];
            const grouped = {};

            // Sort positions by time
            positions.sort((a, b) => new Date(a.timeBRT) - new Date(b.timeBRT));

            for (const pos of positions) {
                // Create group key: symbol + type
                const groupKey = `${pos.symbol}_${pos.type}`;

                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }

                // Check if this position belongs to the last trade in this group
                const currentGroup = grouped[groupKey];

                if (currentGroup.length === 0) {
                    // First position in this group
                    currentGroup.push([pos]);
                } else {
                    const lastTrade = currentGroup[currentGroup.length - 1];
                    const lastPos = lastTrade[lastTrade.length - 1];

                    // Check if positions are related (same exit +/- 0.5%)
                    const exitTolerance = Math.abs(pos.exit - lastPos.exit) / lastPos.exit;

                    // Check time difference (within 4 hours)
                    const timeDiff = Math.abs(new Date(pos.timeBRT) - new Date(lastPos.timeBRT)) / (1000 * 60 * 60);

                    if (exitTolerance <= 0.005 && timeDiff <= 4) {
                        // Add to existing trade
                        lastTrade.push(pos);
                    } else {
                        // Start new trade
                        currentGroup.push([pos]);
                    }
                }
            }

            // Convert grouped positions to trade objects
            for (const groupKey in grouped) {
                for (const posGroup of grouped[groupKey]) {
                    if (posGroup.length === 1) {
                        // Single position trade
                        const pos = posGroup[0];
                        trades.push({
                            symbol: pos.symbol,
                            type: pos.type,
                            entry: pos.entry,
                            exit: pos.exit,
                            volume: pos.volume,
                            pnl: pos.pnl,
                            timeBRT: pos.timeBRT,
                            timeUTC: pos.timeUTC,
                            openHourBRT: pos.openHourBRT,
                            orderID: pos.orderID,
                            isGrouped: false,
                            groupCount: 1,
                            positions: [{
                                orderID: pos.orderID,
                                entryPrice: pos.entry,
                                exitPrice: pos.exit,
                                volume: pos.volume,
                                pnl: pos.pnl,
                                timeBRT: pos.timeBRT
                            }]
                        });
                    } else {
                        // Grouped trade - calculate weighted averages
                        const totalVolume = posGroup.reduce((sum, p) => sum + p.volume, 0);
                        const totalPnL = posGroup.reduce((sum, p) => sum + p.pnl, 0);

                        // Weighted average entry
                        const weightedEntry = totalVolume > 0
                            ? posGroup.reduce((sum, p) => sum + (p.entry * p.volume), 0) / totalVolume
                            : posGroup.reduce((sum, p) => sum + p.entry, 0) / posGroup.length;

                        // Weighted average exit
                        const weightedExit = totalVolume > 0
                            ? posGroup.reduce((sum, p) => sum + (p.exit * p.volume), 0) / totalVolume
                            : posGroup.reduce((sum, p) => sum + p.exit, 0) / posGroup.length;

                        // First and last times
                        const firstPos = posGroup[0];
                        const lastPos = posGroup[posGroup.length - 1];

                        trades.push({
                            symbol: firstPos.symbol,
                            type: firstPos.type,
                            entry: parseFloat(weightedEntry.toFixed(2)),
                            exit: parseFloat(weightedExit.toFixed(2)),
                            volume: totalVolume,
                            pnl: totalPnL,
                            timeBRT: firstPos.timeBRT,
                            timeUTC: firstPos.timeUTC,
                            openHourBRT: firstPos.openHourBRT,
                            orderID: posGroup.map(p => p.orderID).join(';'),
                            isGrouped: true,
                            groupCount: posGroup.length,
                            positions: posGroup.map(p => ({
                                orderID: p.orderID,
                                entryPrice: p.entry,
                                exitPrice: p.exit,
                                volume: p.volume,
                                pnl: p.pnl,
                                timeBRT: p.timeBRT
                            }))
                        });
                    }
                }
            }

            return trades;
        }

        function renderDetectionResults(trades) {
            const container = document.getElementById('detection-results');

            let html = '<div class="space-y-4">';

            trades.forEach((trade, index) => {
                const profitClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';

                if (trade.isGrouped) {
                    // Render grouped trade
                    html += `
          <div class="border-2 border-blue-300 bg-blue-50 rounded-lg p-4 hover:border-blue-400 transition-colors">
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded">
                    üìä ${trade.groupCount} POSICIONES
                  </span>
                  <h4 class="font-bold text-slate-800">${trade.symbol} <span class="text-sm font-normal ${trade.type === 'LONG' ? 'text-green-600' : 'text-red-600'}">${trade.type}</span></h4>
                </div>
                <p class="text-xs text-slate-500">Order IDs: ${trade.orderID}</p>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold ${profitClass}">$${trade.pnl.toFixed(2)}</p>
                <p class="text-xs text-slate-500">Total PnL</p>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
              <div>
                <p class="text-xs text-slate-500">Avg Entry</p>
                <p class="font-semibold text-slate-700">${trade.entry}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Avg Exit</p>
                <p class="font-semibold text-slate-700">${trade.exit}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Total Volume</p>
                <p class="font-semibold text-slate-700">${trade.volume}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">First Entry</p>
                <p class="font-semibold text-slate-700">${trade.timeBRT.split(' ')[1].slice(0, 5)}</p>
              </div>
            </div>

            <div class="bg-white rounded border border-blue-200 p-3 mb-3">
              <p class="text-xs font-semibold text-slate-600 mb-2">Posiciones detectadas:</p>
              <div class="space-y-1 text-xs">
                ${trade.positions.map((pos, i) => {
                    const posProfitClass = pos.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                    return `<div class="flex justify-between">
                      <span class="text-slate-600">‚îú‚îÄ ${pos.entryPrice} (Vol: ${pos.volume})</span>
                      <span class="font-semibold ${posProfitClass}">${pos.pnl >= 0 ? '+' : ''}$${pos.pnl.toFixed(2)}</span>
                    </div>`;
                }).join('')}
              </div>
            </div>

            <button
              onclick="selectTradeForCompletion(${index})"
              class="w-full px-4 py-2 bg-blue-primary text-white rounded-lg text-sm font-medium hover:bg-blue-hover transition-all"
            >
              ‚úçÔ∏è Completar este Trade
            </button>
          </div>
        `;
                } else {
                    // Render simple trade
                    html += `
          <div class="border border-slate-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-slate-800">${trade.symbol} <span class="text-sm font-normal ${trade.type === 'LONG' ? 'text-green-600' : 'text-red-600'}">${trade.type}</span></h4>
                <p class="text-xs text-slate-500">Order ID: ${trade.orderID}</p>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold ${profitClass}">$${trade.pnl.toFixed(2)}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
              <div>
                <p class="text-xs text-slate-500">Entry</p>
                <p class="font-semibold text-slate-700">${trade.entry}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Exit</p>
                <p class="font-semibold text-slate-700">${trade.exit}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Volume</p>
                <p class="font-semibold text-slate-700">${trade.volume}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Time (BRT)</p>
                <p class="font-semibold text-slate-700">${trade.timeBRT.split(' ')[1].slice(0, 5)}</p>
              </div>
            </div>

            <button
              onclick="selectTradeForCompletion(${index})"
              class="w-full px-4 py-2 bg-blue-primary text-white rounded-lg text-sm font-medium hover:bg-blue-hover transition-all"
            >
              ‚úçÔ∏è Completar este Trade
            </button>
          </div>
        `;
                }
            });

            html += '</div>';

            container.innerHTML = html;
        }

        // ==========================================
        // STEP 3: SELECT TRADE FOR COMPLETION
        // ==========================================
        async function selectTradeForCompletion(index) {
            currentTrade = detectedTrades[index];

            updateStepIndicator(3);

            // Get next trade number
            const nextTradeNumber = await getNextTradeNumber();

            // Pre-fill form
            document.getElementById('trade-number').value = nextTradeNumber;
            document.getElementById('trade-number-hint').textContent = `Sugerido: ${nextTradeNumber} (√∫ltimo trade registrado: ${nextTradeNumber - 1})`;

            // Pre-fill Take Profit with exitPrice
            if (currentTrade.exit) {
                document.getElementById('take-profit').value = currentTrade.exit.toFixed(2);
            }

            // Render stop loss inputs based on trade type
            renderStopLossInputs();

            // Show step 3
            document.getElementById('step-3').classList.remove('hidden');
            document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'start' });

            showMessage('‚úçÔ∏è Completa los datos del trade', 'info');
        }

        // ==========================================
        // RENDER STOP LOSS INPUTS (v2.0)
        // ==========================================
        function renderStopLossInputs() {
            const container = document.getElementById('stop-loss-container');

            if (!currentTrade) return;

            if (currentTrade.isGrouped) {
                // Render stops for each position + apply to all button
                let html = `
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            üìä Trade Agrupado: ${currentTrade.groupCount} Posiciones
                        </h4>
                        <div class="space-y-3">
                `;

                currentTrade.positions.forEach((pos, index) => {
                    html += `
                        <div class="bg-white border border-slate-200 rounded p-3">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-medium text-slate-600">
                                    Posici√≥n ${index + 1}: Entry ${pos.entryPrice} (Vol: ${pos.volume})
                                </p>
                                <p class="text-xs font-semibold ${pos.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${pos.pnl >= 0 ? '+' : ''}$${pos.pnl.toFixed(2)}
                                </p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Stop Loss <span class="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        id="pos-${index}-stop"
                                        data-position-index="${index}"
                                        placeholder="0.00"
                                        oninput="onStopChange(${index})"
                                        class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-primary"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Risk</label>
                                    <p class="text-sm font-bold text-slate-700 px-3 py-2 bg-slate-100 rounded" id="pos-${index}-risk">--</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-300">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                                <p class="text-xs font-semibold text-blue-900 mb-2">üîó Aplicar mismo stop a todas las posiciones</p>
                                <div class="flex gap-2">
                                    <input
                                        type="number"
                                        step="0.01"
                                        id="apply-stop-input"
                                        placeholder="Stop Loss"
                                        class="flex-1 px-3 py-2 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-primary"
                                    >
                                    <button
                                        type="button"
                                        onclick="applyStopToAll()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition-all"
                                    >
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-slate-500 mb-1">Risk Ejecutado Total</p>
                                <p class="text-2xl font-bold text-slate-800" id="total-risk-executed">$0.00</p>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } else {
                // Render single stop loss input
                let html = `
                    <div>
                        <label for="stop-loss" class="block text-sm font-medium text-slate-700 mb-2">
                            Stop Loss <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="number"
                            step="0.01"
                            id="stop-loss"
                            name="stopLoss"
                            required
                            placeholder="0.00"
                            oninput="updateCalculationPreview()"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent"
                        >
                    </div>
                `;

                container.innerHTML = html;
            }
        }

        // ==========================================
        // POSITION STOP CHANGE HANDLERS (v2.0)
        // ==========================================
        function onStopChange(positionIndex) {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const position = currentTrade.positions[positionIndex];
            const stopInput = document.getElementById(`pos-${positionIndex}-stop`);
            const stop = parseFloat(stopInput.value);

            if (isNaN(stop) || stop === 0) {
                document.getElementById(`pos-${positionIndex}-risk`).textContent = '--';
                updateTotalRisk();
                return;
            }

            // Calculate risk for this position
            const riskPerUnit = Math.abs(position.entryPrice - stop);
            const risk = riskPerUnit * position.volume;

            // Update display
            document.getElementById(`pos-${positionIndex}-risk`).textContent = `$${risk.toFixed(2)}`;

            // Save in object
            position.stopLoss = stop;
            position.riskPerUnit = riskPerUnit;
            position.riskExecuted = risk;

            // Recalculate total
            updateTotalRisk();
            updateCalculationPreview();
        }

        function updateTotalRisk() {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const totalRisk = currentTrade.positions.reduce(
                (sum, p) => sum + (p.riskExecuted || 0),
                0
            );

            document.getElementById('total-risk-executed').textContent = `$${totalRisk.toFixed(2)}`;

            currentTrade.riskExecuted = totalRisk;
        }

        function applyStopToAll() {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const stopValue = document.getElementById('apply-stop-input').value;
            const stop = parseFloat(stopValue);

            if (isNaN(stop) || stop === 0) {
                showMessage('Ingresa un stop v√°lido', 'warning');
                return;
            }

            // Apply to all positions
            currentTrade.positions.forEach((position, index) => {
                document.getElementById(`pos-${index}-stop`).value = stop;
                onStopChange(index);
            });

            showMessage(`Stop ${stop} aplicado a todas las posiciones`, 'success');
        }

        async function getNextTradeNumber() {
            try {
                const result = await window.storage.get(CONFIG.storageKeys.trades);

                if (result && result.value) {
                    const data = JSON.parse(result.value);
                    if (data.trades && data.trades.length > 0) {
                        const maxTradeNumber = Math.max(...data.trades.map(t => t.tradeNumber));
                        return maxTradeNumber + 1;
                    }
                }
            } catch (error) {
                console.error('Error getting next trade number:', error);
            }

            return 1; // First trade
        }

        function goBackToDetection() {
            document.getElementById('step-3').classList.add('hidden');
            updateStepIndicator(2);
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==========================================
        // BROKE RULES TOGGLE
        // ==========================================
        function toggleBrokeRulesNotes() {
            const checkbox = document.getElementById('broke-rules');
            const container = document.getElementById('rules-violated-container');

            if (!checkbox || !container) {
                console.error('Broke rules elements not found');
                return;
            }

            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                const textarea = document.getElementById('rules-violated');
                if (textarea) textarea.value = '';
            }
        }

        // ==========================================
        // CALCULATION PREVIEW (v2.0)
        // ==========================================
        function updateCalculationPreview() {
            if (!currentTrade) return;

            const riskPlanned = parseFloat(document.getElementById('risk-planned').value) || 0;

            let riskExecuted = 0;

            if (currentTrade.isGrouped) {
                // Use total risk from positions
                riskExecuted = currentTrade.riskExecuted || 0;
            } else {
                // Calculate from single stop loss
                const stopLossInput = document.getElementById('stop-loss');
                if (!stopLossInput) return;

                const stopLoss = parseFloat(stopLossInput.value) || 0;
                if (!stopLoss) return;

                const entry = currentTrade.entry;
                const volume = currentTrade.volume;
                const riskPerUnit = Math.abs(entry - stopLoss);
                riskExecuted = riskPerUnit * volume;
            }

            if (!riskPlanned || riskExecuted === 0) {
                // Reset preview
                document.getElementById('preview-risk-executed').textContent = '--';
                document.getElementById('preview-risk-deviation').textContent = '--';
                document.getElementById('preview-r-planned').textContent = '--';
                document.getElementById('preview-r-executed').textContent = '--';
                return;
            }

            // Calculate deviation
            const deviation = riskExecuted - riskPlanned;
            const deviationPercent = ((deviation / riskPlanned) * 100).toFixed(1);

            // Calculate R values
            const rPlanned = riskPlanned > 0 ? (currentTrade.pnl / riskPlanned).toFixed(2) : '0.00';
            const rExecuted = riskExecuted > 0 ? (currentTrade.pnl / riskExecuted).toFixed(2) : '0.00';

            // Update preview
            document.getElementById('preview-risk-executed').textContent = `$${riskExecuted.toFixed(2)}`;
            document.getElementById('preview-risk-deviation').textContent = `${deviation > 0 ? '+' : ''}$${deviation.toFixed(2)} (${deviationPercent > 0 ? '+' : ''}${deviationPercent}%)`;
            document.getElementById('preview-r-planned').textContent = `${rPlanned}R`;
            document.getElementById('preview-r-executed').textContent = `${rExecuted}R`;
        }

        // ==========================================
        // STEP 4: SAVE TRADE
        // ==========================================
        async function handleTradeSubmit(e) {
            e.preventDefault();

            // Clear previous errors
            hideFormError();

            if (!currentTrade) {
                showMessage('‚ùå Error: No hay trade seleccionado', 'error');
                return;
            }

            showMessage('üíæ Guardando trade...', 'info');

            try {
                // Build complete trade object
                const formData = new FormData(e.target);
                const completeTrade = buildCompleteTrade(currentTrade, formData);

                // Validate against daily plan
                const validation = validateAgainstPlan(completeTrade);
                if (!validation.valid) {
                    if (!confirm(validation.message + '\n\n¬øGuardar de todos modos?')) {
                        return;
                    }
                }

                // Save to storage
                const saveResult = await saveTrade(completeTrade);

                if (!saveResult.success) {
                    throw new Error(saveResult.error);
                }

                // Generate outputs
                generateOutputs(completeTrade);

                // Show success step
                updateStepIndicator(4);
                document.getElementById('step-3').classList.add('hidden');
                document.getElementById('step-4').classList.remove('hidden');
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'start' });

                showMessage('‚úÖ Trade guardado exitosamente', 'success');

            } catch (error) {
                showFormError(error.message);
                console.error(error);
            }
        }

        function buildCompleteTrade(detectedTrade, formData) {
            const takeProfitValue = formData.get('takeProfit');
            const takeProfit = takeProfitValue ? parseFloat(takeProfitValue) : null;
            const riskPlanned = parseFloat(formData.get('riskPlanned'));

            let stopLoss, riskExecuted, positions, orderIDs;

            if (detectedTrade.isGrouped) {
                // For grouped trades, use positions data
                positions = detectedTrade.positions.map(p => ({
                    ...p,
                    stopLoss: p.stopLoss,
                    takeProfit: takeProfit,
                    riskPerUnit: p.riskPerUnit,
                    riskExecuted: p.riskExecuted
                }));

                // Calculate average stop loss
                stopLoss = positions.reduce((sum, p) => sum + p.stopLoss, 0) / positions.length;

                // Use total risk from positions
                riskExecuted = detectedTrade.riskExecuted;

                // Collect all order IDs
                orderIDs = detectedTrade.orderID.split(';');

            } else {
                // For simple trades, get stop from form
                stopLoss = parseFloat(formData.get('stopLoss'));

                // Calculate risk executed
                const entry = detectedTrade.entry;
                const volume = detectedTrade.volume;
                const riskPerUnit = Math.abs(entry - stopLoss);
                riskExecuted = riskPerUnit * volume;

                // Single position
                positions = [{
                    orderID: detectedTrade.orderID,
                    entryPrice: detectedTrade.entry,
                    exitPrice: detectedTrade.exit,
                    stopLoss: stopLoss,
                    takeProfit: takeProfit,
                    volume: detectedTrade.volume,
                    pnl: detectedTrade.pnl,
                    timeBRT: detectedTrade.timeBRT,
                    riskPerUnit: riskPerUnit,
                    riskExecuted: riskExecuted
                }];

                orderIDs = [detectedTrade.orderID];
            }

            // Calculate deviation
            const riskDeviation = riskExecuted - riskPlanned;
            const riskDeviationPercent = (riskDeviation / riskPlanned) * 100;

            // Risk deviation flag
            let flag = '‚úì';
            if (Math.abs(riskDeviationPercent) > 20) {
                flag = '‚ùå';
            } else if (Math.abs(riskDeviationPercent) > 10) {
                flag = '‚ö†';
            }

            const rPlanned = riskPlanned > 0 ? detectedTrade.pnl / riskPlanned : 0;
            const rExecuted = riskExecuted > 0 ? detectedTrade.pnl / riskExecuted : 0;

            // Parse rules violated
            let rulesViolated = [];
            if (formData.get('brokeRules') === 'on') {
                const rulesText = formData.get('rulesViolated') || '';
                rulesViolated = rulesText.split('\n').filter(r => r.trim());
            }

            return {
                tradeNumber: parseInt(formData.get('tradeNumber')),
                block: parseInt(formData.get('block')) || 1,
                orderIDs: orderIDs,
                isGrouped: detectedTrade.isGrouped,
                groupCount: detectedTrade.groupCount,
                positions: positions,

                // Times
                openTimeBRT: detectedTrade.timeBRT,
                closeTimeBRT: detectedTrade.timeBRT, // Same for now (we don't have close time from Funding data)
                openTimeUTC: detectedTrade.timeUTC,
                closeTimeUTC: detectedTrade.timeUTC,
                openHourBRT: detectedTrade.openHourBRT,
                openHourRange: getHourRange(detectedTrade.openHourBRT),
                openDayOfWeek: getDayOfWeek(new Date(detectedTrade.timeBRT)),
                duration: 'N/A', // Not available in Funding data
                durationMinutes: 0,

                // Trade data
                symbol: detectedTrade.symbol,
                type: detectedTrade.type,
                entry: detectedTrade.entry,
                exitPrice: detectedTrade.exit,
                stopLoss: parseFloat(stopLoss.toFixed(2)),
                takeProfit: takeProfit,
                volume: detectedTrade.volume,

                // Risk and results
                riskPlanned: riskPlanned,
                riskExecuted: parseFloat(riskExecuted.toFixed(2)),
                riskDeviation: parseFloat(riskDeviation.toFixed(2)),
                riskDeviationFlag: flag,
                result: detectedTrade.pnl,
                rPlanned: parseFloat(rPlanned.toFixed(2)),
                rExecuted: parseFloat(rExecuted.toFixed(2)),

                // Metadata
                item: formData.get('item') || '',
                observation: formData.get('observation') || '',
                whatWentWell: formData.get('whatWentWell') || '',
                whatWentWrong: formData.get('whatWentWrong') || '',
                followedPlan: formData.get('followedPlan') === 'on',
                brokeRules: formData.get('brokeRules') === 'on',
                rulesViolated: rulesViolated,

                // Volume tracking
                volumeCalculated: false,
                volumeAssumed: false,
                volumeSource: 'platform',

                // Timestamps
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        function getHourRange(hour) {
            if (hour >= 9 && hour < 12) return '9-12';
            if (hour >= 12 && hour < 15) return '12-15';
            if (hour >= 15 && hour < 18) return '15-18';
            return 'other';
        }

        function getDayOfWeek(date) {
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            return days[date.getDay()];
        }

        function validateAgainstPlan(trade) {
            if (!dailyPlan) {
                return { valid: true };
            }

            // Check max trades
            // TODO: Get current trade count from storage

            // Check max loss
            if (trade.result < 0) {
                const maxLoss = parseFloat(dailyPlan.maxDailyLoss) || 0;
                if (Math.abs(trade.result) > maxLoss) {
                    return {
                        valid: false,
                        message: `‚ö†Ô∏è Este trade excede tu max daily loss ($${maxLoss})`
                    };
                }
            }

            return { valid: true };
        }

        async function saveTrade(trade) {
            try {
                // Check if this is a Quick Add completion
                const isQuickAddCompletion = window.currentQuickAddCompletion &&
                                            window.currentQuickAddCompletion.quickAddID;

                if (isQuickAddCompletion) {
                    // UPDATE existing Quick Add trade
                    const quickAddID = window.currentQuickAddCompletion.quickAddID;

                    console.log('üìù Updating Quick Add:', quickAddID);

                    // Add completion metadata
                    trade.isQuickAdd = false;
                    trade.completedAt = new Date().toISOString();
                    trade.originalQuickAddTimestamp = window.currentQuickAddCompletion.quickAddTimestamp;

                    // Update the trade using StorageManager
                    const success = await StorageManager.updateTrade(quickAddID, trade);

                    if (success) {
                        // Clear the completion flag
                        window.currentQuickAddCompletion = null;

                        console.log('‚úÖ Quick Add updated successfully');

                        // Refresh pending Quick Adds
                        await loadPendingQuickAdds();

                        return {
                            success: true,
                            message: '‚úÖ Quick Add completado exitosamente!'
                        };
                    } else {
                        return {
                            success: false,
                            error: 'Error al actualizar Quick Add'
                        };
                    }

                } else {
                    // NORMAL FLOW: Create new trade
                    // Get existing trades
                    let tradesData = {
                        version: '1.0',
                        lastUpdated: new Date().toISOString(),
                        totalTrades: 0,
                        trades: []
                    };

                    const result = await window.storage.get(CONFIG.storageKeys.trades);
                    if (result && result.value) {
                        tradesData = JSON.parse(result.value);
                    }

                    // Check for duplicates
                    const isDuplicate = tradesData.trades.some(t =>
                        t.orderIDs && t.orderIDs.some(id => trade.orderIDs.includes(id))
                    );

                    if (isDuplicate) {
                        return {
                            success: false,
                            error: 'Trade duplicado: Order ID ya existe en el sistema'
                        };
                    }

                    // Add trade
                    tradesData.trades.push(trade);
                    tradesData.totalTrades = tradesData.trades.length;
                    tradesData.lastUpdated = new Date().toISOString();

                    // Save
                    await window.storage.set(CONFIG.storageKeys.trades, JSON.stringify(tradesData));

                    console.log('‚úÖ Trade saved:', trade);
                }

                return {
                    success: true,
                    trade: trade
                };

            } catch (error) {
                console.error('Error in saveTrade:', error);
                return {
                    success: false,
                    error: 'Error guardando en storage: ' + error.message
                };
            }
        }

        function generateOutputs(trade) {
            // Generate Telegram template with ALL observations
            const resultSign = trade.result >= 0 ? '+' : '';
            const deviationSign = trade.riskDeviation >= 0 ? '+' : '';
            const deviationPercent = ((trade.riskDeviation / trade.riskPlanned) * 100).toFixed(1);
            const rSign = trade.rExecuted >= 0 ? '+' : '';

            // Build Telegram template
            let telegram = `üîπ Trade #${trade.tradeNumber} - ${trade.symbol}\n`;
            telegram += `${trade.type === 'LONG' ? 'üìà LONG' : 'üìâ SHORT'}\n\n`;
            telegram += `Entry: ${trade.entry.toFixed(2)}\n`;
            telegram += `Exit: ${trade.exitPrice.toFixed(2)}\n`;
            telegram += `Stop: ${trade.stopLoss.toFixed(2)}${trade.takeProfit ? ' | TP: ' + trade.takeProfit.toFixed(2) : ''}\n\n`;
            telegram += `Volume: ${trade.volume}\n`;
            telegram += `Result: ${resultSign}$${Math.abs(trade.result).toFixed(2)}\n`;
            telegram += `R Real: ${rSign}${trade.rExecuted.toFixed(2)}R\n`;

            // Risk planned and deviation
            if (trade.riskPlanned) {
                telegram += `\n(Planeado: $${trade.riskPlanned.toFixed(2)}`;
                if (trade.riskDeviation !== undefined) {
                    const devSymbol = Math.abs(deviationPercent) <= 10 ? '‚úì' : '‚ö†Ô∏è';
                    telegram += ` | Desviaci√≥n: ${deviationSign}${deviationPercent}% ${devSymbol}`;
                }
                telegram += ')\n';
            }

            // Setup/Item
            if (trade.item && trade.item.trim()) {
                telegram += `\nüìã Setup: ${trade.item}\n`;
            }

            // General observations
            if (trade.observation && trade.observation.trim()) {
                telegram += `\nüí≠ Observaciones:\n${trade.observation}\n`;
            }

            // What went well
            if (trade.whatWentWell && trade.whatWentWell.trim()) {
                telegram += `\n‚úÖ Lo que sali√≥ bien:\n`;
                const wellPoints = trade.whatWentWell.split('\n').filter(p => p.trim());
                wellPoints.forEach(point => {
                    telegram += `- ${point.trim()}\n`;
                });
            }

            // What went wrong
            if (trade.whatWentWrong && trade.whatWentWrong.trim()) {
                telegram += `\n‚ùå Lo que sali√≥ mal:\n`;
                const wrongPoints = trade.whatWentWrong.split('\n').filter(p => p.trim());
                wrongPoints.forEach(point => {
                    telegram += `- ${point.trim()}\n`;
                });
            }

            // Plan compliance
            telegram += `\nüìä Cumplimiento:\n`;
            if (trade.followedPlan) {
                telegram += `‚úÖ Segu√≠ el plan\n`;
            }
            if (trade.brokeRules) {
                telegram += `‚ùå Romp√≠ reglas`;
                if (trade.rulesViolated && trade.rulesViolated.length > 0) {
                    telegram += `: ${trade.rulesViolated.join(', ')}`;
                }
                telegram += `\n`;
            }

            // Daily limits info (fetch from localStorage)
            const todayKey = new Date().toISOString().split('T')[0];
            const limitsData = JSON.parse(localStorage.getItem(`limits-${todayKey}`) || '{}');
            const maxLoss = limitsData.maxDailyLoss ? `$${limitsData.maxDailyLoss}` : '---';
            const maxTrades = limitsData.maxTrades || '---';

            // Count today's trades (need to call async, but we'll use a synchronous approach)
            const tradesCountText = trade.tradeNumber || '1';

            telegram += `Max Loss respetado: ${maxLoss}\n`;
            telegram += `Trades ejecutados: ${tradesCountText} / ${maxTrades}`;

            document.getElementById('telegram-output').textContent = telegram;

            // CSV line with ALL fields - escape commas and newlines
            const escape = (text) => {
                if (!text) return '';
                return String(text)
                    .replace(/,/g, ';')
                    .replace(/\n/g, ' ')
                    .replace(/\r/g, '')
                    .trim();
            };

            const csv = [
                trade.tradeNumber,
                trade.block || 1,
                trade.orderIDs.join(';'),
                trade.symbol,
                trade.type,
                trade.entry.toFixed(2),
                trade.exitPrice.toFixed(2),
                trade.volume,
                trade.result.toFixed(2),
                trade.stopLoss.toFixed(2),
                trade.takeProfit ? trade.takeProfit.toFixed(2) : '',
                trade.riskPlanned ? trade.riskPlanned.toFixed(2) : '',
                trade.riskExecuted ? trade.riskExecuted.toFixed(2) : '',
                trade.rExecuted ? trade.rExecuted.toFixed(2) : '',
                escape(trade.item || ''),
                trade.followedPlan ? 'Yes' : 'No',
                trade.brokeRules ? 'Yes' : 'No',
                escape(trade.observation || ''),
                escape(trade.whatWentWell || ''),
                escape(trade.whatWentWrong || ''),
                trade.openTimeBRT || '',
                trade.createdAt || new Date().toISOString()
            ].join(',');

            document.getElementById('csv-output').textContent = csv;
        }

        // ==========================================
        // RESET PARSER
        // ==========================================
        function resetParser() {
            // Clear all forms
            document.getElementById('raw-data').value = '';
            document.getElementById('trade-form').reset();

            // Hide steps
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');

            // Reset state
            detectedTrades = [];
            currentTrade = null;

            // Reset step indicator
            updateStepIndicator(1);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showMessage('Parser reiniciado', 'info');
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.querySelector(`.step-active, .step-completed, .step-inactive`);
                // This is simplified - in production you'd target each step individually
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('status-message');

            messageEl.className = 'slide-in max-w-7xl mx-auto mt-4 px-4';

            let bgColor, textColor, borderColor;

            if (type === 'success') {
                bgColor = 'bg-green-50';
                textColor = 'text-green-800';
                borderColor = 'border-green-200';
            } else if (type === 'error') {
                bgColor = 'bg-red-50';
                textColor = 'text-red-800';
                borderColor = 'border-red-200';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-50';
                textColor = 'text-amber-800';
                borderColor = 'border-amber-200';
            } else {
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-800';
                borderColor = 'border-blue-200';
            }

            messageEl.innerHTML = `
        <div class="${bgColor} ${textColor} ${borderColor} border rounded-lg px-4 py-3 text-sm font-medium">
          ${text}
        </div>
      `;

            messageEl.classList.remove('hidden');

            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }

        function showFormError(text) {
            const errorEl = document.getElementById('form-error-message');

            errorEl.innerHTML = `
    <div class="bg-red-50 text-red-800 border-2 border-red-300 rounded-lg px-4 py-3 text-sm font-medium">
      <div class="flex items-start gap-3">
        <span class="text-xl">‚ùå</span>
        <div class="flex-1">
          <p class="font-bold mb-1">Error al guardar</p>
          <p>${text}</p>
        </div>
      </div>
    </div>
  `;

            errorEl.classList.remove('hidden');

            // Scroll to error (smooth)
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideFormError() {
            const errorEl = document.getElementById('form-error-message');
            errorEl.classList.add('hidden');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Copiado al portapapeles', 'success');
            }).catch(err => {
                showMessage('‚ùå Error copiando: ' + err, 'error');
            });
        }

        // ==========================================
        // QUICK ADD FUNCTIONS
        // ==========================================

        async function initializeQuickAdd() {
            // Initialize Storage Manager
            await StorageManager.init();

            // Load today's daily plan
            dailyPlan = await StorageManager.getTodayDailyPlan();

            // Load pending quick adds
            await loadPendingQuickAdds();
        }

        // ==========================================
        // DAILY LIMITS PERSISTENCE
        // ==========================================

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function saveTodayLimits(maxLoss, maxTrades) {
            try {
                const today = new Date();
                const dateKey = formatDateKey(today);

                const limitsData = {
                    date: dateKey,
                    maxDailyLoss: maxLoss,
                    maxTrades: maxTrades,
                    savedAt: new Date().toISOString()
                };

                await window.storage.set(`limits-${dateKey}`, JSON.stringify(limitsData));
                console.log('L√≠mites guardados:', limitsData);
                return true;
            } catch (error) {
                console.error('Error saving limits:', error);
                return false;
            }
        }

        async function loadTodayLimits() {
            try {
                const today = new Date();
                const dateKey = formatDateKey(today);

                // Intentar cargar l√≠mites guardados
                const result = await window.storage.get(`limits-${dateKey}`);
                if (result?.value) {
                    const limits = JSON.parse(result.value);
                    console.log('L√≠mites cargados:', limits);
                    return {
                        maxDailyLoss: limits.maxDailyLoss,
                        maxTrades: limits.maxTrades
                    };
                }

                // Si no hay l√≠mites guardados, buscar en daily plan
                if (dailyPlan) {
                    console.log('Usando l√≠mites del Daily Plan');
                    return {
                        maxDailyLoss: dailyPlan.riskManagement?.maxDailyLoss ||
                                      dailyPlan.maxDailyLoss || 400,
                        maxTrades: dailyPlan.riskManagement?.maxTrades ||
                                  dailyPlan.maxTrades || 5
                    };
                }

                // Valores por defecto
                console.log('Usando l√≠mites por defecto');
                return { maxDailyLoss: 400, maxTrades: 5 };

            } catch (error) {
                console.error('Error loading limits:', error);
                return { maxDailyLoss: 400, maxTrades: 5 };
            }
        }

        async function openQuickAddModal() {
            // Show modal
            document.getElementById('quickAddModal').classList.remove('hidden');

            // Cargar l√≠mites guardados del d√≠a
            const limits = await loadTodayLimits();

            // Setear l√≠mites en los inputs
            document.getElementById('qa-max-loss').value = limits.maxDailyLoss;
            document.getElementById('qa-max-trades').value = limits.maxTrades;

            // Clear other inputs
            document.getElementById('qa-symbol').value = '';
            document.getElementById('qa-pnl').value = '';

            // Update running totals
            await updateRunningTotals();
        }

        async function saveLimitsOnChange() {
            const maxLoss = parseFloat(document.getElementById('qa-max-loss').value) || 400;
            const maxTrades = parseInt(document.getElementById('qa-max-trades').value) || 5;

            await saveTodayLimits(maxLoss, maxTrades);
            await updateRunningTotals();
        }

        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.add('hidden');
        }

        async function updateRunningTotals() {
            try {
                // Get today's trades
                const todayTrades = await StorageManager.getTodayTrades();

                console.log('=== Running Totals Debug ===');
                console.log('Fecha actual:', new Date().toISOString());
                console.log('Trades de hoy:', todayTrades.length);
                console.log('Trades:', todayTrades.map(t => ({
                    symbol: t.symbol,
                    pnl: t.pnl,
                    timestamp: t.timestamp,
                    isQuickAdd: t.isQuickAdd
                })));

                // Calculate totals
                const totalPnL = todayTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const tradeCount = todayTrades.length;

                console.log('P&L total HOY:', totalPnL);
                console.log('Cantidad HOY:', tradeCount);

                // Get limits from INPUTS (editables)
                const maxLossInput = document.getElementById('qa-max-loss');
                const maxTradesInput = document.getElementById('qa-max-trades');

                const maxLoss = parseFloat(maxLossInput?.value) || 400;
                const maxTrades = parseInt(maxTradesInput?.value) || 5;

                // Calculate remaining
                // maxLoss is positive (e.g., 400 = you can lose up to $400)
                // totalPnL is positive if gains, negative if losses
                // If you gain +$100, you have MORE room to lose: 400 + 100 = 500
                // If you lose -$100, you have LESS room to lose: 400 + (-100) = 300
                const remaining = Math.abs(maxLoss) + totalPnL;
                const percentUsed = Math.abs(totalPnL / maxLoss) * 100;

                console.log('L√≠mite restante:', remaining);
                console.log('=========================');

                // Update UI
                document.getElementById('qa-total-pnl').textContent = `${totalPnL.toFixed(2)}`;
                document.getElementById('qa-total-pnl').className = totalPnL >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';

                document.getElementById('qa-trade-count').textContent = `${tradeCount} / ${maxTrades}`;
                document.getElementById('qa-remaining').textContent = `${remaining.toFixed(2)}`;

                // Show warning if > 80%
                const warningDiv = document.getElementById('qa-warning');
                if (percentUsed >= 80) {
                    warningDiv.classList.remove('hidden');
                    warningDiv.textContent = `‚ö†Ô∏è Has usado ${percentUsed.toFixed(0)}% de tu l√≠mite diario`;
                } else {
                    warningDiv.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error updating running totals:', error);
            }
        }

        async function saveQuickAdd() {
            console.log('=== SAVE QUICK ADD DEBUG ===');

            const symbol = document.getElementById('qa-symbol').value;
            const pnl = parseFloat(document.getElementById('qa-pnl').value);

            console.log('Symbol:', symbol);
            console.log('P&L:', pnl);

            // Validation
            if (!symbol || symbol.trim() === '') {
                console.log('‚ùå Validation failed: Empty symbol');
                alert('Por favor ingresa un symbol');
                return;
            }

            if (isNaN(pnl) || pnl === 0) {
                console.log('‚ùå Validation failed: Invalid P&L');
                alert('Por favor ingresa un P&L v√°lido');
                return;
            }

            console.log('‚úÖ Validation passed');

            // Check limits
            const todayTrades = await StorageManager.getTodayTrades();
            console.log('Today trades count:', todayTrades.length);

            const maxTrades = parseInt(document.getElementById('qa-max-trades').value) || 5;
            console.log('Max trades limit:', maxTrades);

            if (todayTrades.length >= maxTrades) {
                if (!confirm(`‚ö†Ô∏è Ya alcanzaste tu l√≠mite de ${maxTrades} trades. ¬øContinuar?`)) {
                    console.log('User cancelled: Max trades limit');
                    return;
                }
            }

            const totalPnL = todayTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            const maxLoss = parseFloat(document.getElementById('qa-max-loss').value) || 400;
            const newTotal = totalPnL + pnl;

            console.log('Total P&L:', totalPnL);
            console.log('Max loss limit:', maxLoss);
            console.log('New total after this trade:', newTotal);

            if (Math.abs(newTotal) > Math.abs(maxLoss)) {
                if (!confirm(`‚ö†Ô∏è Este trade exceder√≠a tu l√≠mite de ${maxLoss}. ¬øContinuar?`)) {
                    console.log('User cancelled: Max loss limit');
                    return;
                }
            }

            try {
                // Create quick add trade
                const quickTrade = {
                    orderID: `QA-${Date.now()}`,
                    symbol: symbol.trim().toUpperCase(),
                    pnl: pnl,
                    timestamp: new Date().toISOString(),
                    isQuickAdd: true,
                    side: null,
                    positions: null,
                    stops: null,
                    riskPlanned: null,
                    riskExecuted: null
                };

                console.log('Quick trade object created:', quickTrade);
                console.log('Calling StorageManager.addTrade()...');

                const success = await StorageManager.addTrade(quickTrade);

                console.log('StorageManager.addTrade() result:', success);

                if (success) {
                    console.log('‚úÖ Quick Add saved successfully!');
                    alert('‚úÖ Quick Add guardado!');
                    closeQuickAddModal();
                    console.log('Loading pending quick adds...');
                    await loadPendingQuickAdds();
                    console.log('Updating running totals...');
                    await updateRunningTotals();
                } else {
                    console.log('‚ùå StorageManager.addTrade() returned false');
                    alert('‚ùå Error al guardar');
                }

            } catch (error) {
                console.error('Error saving quick add:', error);
                alert('‚ùå Error al guardar');
            }
        }

        async function loadPendingQuickAdds() {
            try {
                console.log('=== LOAD PENDING QUICK ADDS ===');

                const todayTrades = await StorageManager.getTodayTrades();
                console.log('Today trades:', todayTrades);

                const quickAdds = todayTrades.filter(t => t.isQuickAdd === true);
                console.log('Quick Adds found:', quickAdds.length);
                console.log('Quick Adds:', quickAdds);

                const pendingSection = document.getElementById('quickAddsPending');
                const pendingList = document.getElementById('qa-pending-list');
                const pendingCount = document.getElementById('qa-pending-count');

                if (!pendingSection || !pendingList || !pendingCount) {
                    console.error('‚ùå Pending elements not found in DOM');
                    return;
                }

                if (quickAdds.length === 0) {
                    console.log('No quick adds to display, hiding section');
                    pendingSection.classList.add('hidden');
                    return;
                }

                // Show section
                console.log('Showing pending section with', quickAdds.length, 'quick adds');
                pendingSection.classList.remove('hidden');
                pendingCount.textContent = quickAdds.length;

                // Render list
                pendingList.innerHTML = quickAdds.map(qa => `
                    <div class="bg-white border-2 border-yellow-300 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-2xl">‚ö°</span>
                            <div>
                                <div class="font-bold text-gray-800">${qa.symbol}</div>
                                <div class="text-sm text-gray-600">${new Date(qa.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                            <div class="font-bold text-lg ${qa.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${qa.pnl >= 0 ? '+' : ''}${qa.pnl.toFixed(2)}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="completeQuickAdd('${qa.orderID}')"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                                ‚úèÔ∏è Completar
                            </button>
                            <button onclick="deleteQuickAdd('${qa.orderID}')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');

                console.log('‚úÖ Pending list rendered successfully');

            } catch (error) {
                console.error('‚ùå Error loading pending quick adds:', error);
            }
        }

        /**
         * Open modal to complete a Quick Add with broker data
         */
        async function completeQuickAdd(orderID) {
            try {
                const allTrades = await StorageManager.getTrades();
                const quickAdd = allTrades.trades.find(t => t.orderID === orderID);

                if (!quickAdd) {
                    alert('‚ùå Quick Add no encontrado');
                    return;
                }

                window.currentQuickAdd = quickAdd;
                showCompleteModal(quickAdd);

            } catch (error) {
                console.error('Error loading Quick Add:', error);
                alert('‚ùå Error al cargar Quick Add');
            }
        }

        async function deleteQuickAdd(orderID) {
            if (!confirm('¬øEliminar este Quick Add?')) return;

            const success = await StorageManager.deleteTrade(orderID);
            if (success) {
                await loadPendingQuickAdds();
            }
        }

        // ==========================================
        // COMPLETE QUICK ADD FUNCTIONS
        // ==========================================

        function showCompleteModal(quickAdd) {
            document.getElementById('complete-symbol').textContent = quickAdd.symbol;

            const pnlElem = document.getElementById('complete-pnl');
            pnlElem.textContent = `${quickAdd.pnl >= 0 ? '+' : ''}${quickAdd.pnl.toFixed(2)}`;
            pnlElem.className = `text-xl font-bold ${quickAdd.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`;

            const timestamp = new Date(quickAdd.timestamp);
            document.getElementById('complete-time').textContent = timestamp.toLocaleString('es-ES');

            document.getElementById('complete-broker-data').value = '';
            document.getElementById('parse-preview').classList.add('hidden');
            document.getElementById('complete-validation').classList.add('hidden');

            document.getElementById('completeModal').classList.remove('hidden');
        }

        function closeCompleteModal() {
            document.getElementById('completeModal').classList.add('hidden');
            window.currentQuickAdd = null;
        }

        function previewComplete() {
            const brokerData = document.getElementById('complete-broker-data').value.trim();

            if (!brokerData) {
                alert('Por favor pega los datos del broker');
                return;
            }

            try {
                const lines = brokerData.split('\n').filter(l => l.trim());
                const parsed = parseRawData(brokerData);

                if (!parsed || parsed.length === 0) {
                    alert('‚ùå No se pudo procesar los datos');
                    return;
                }

                // Get the first parsed position
                const position = parsed[0];

                const previewDiv = document.getElementById('parse-preview');
                const previewContent = document.getElementById('parse-preview-content');

                previewContent.innerHTML = `
<strong>Symbol:</strong> ${position.symbol}<br>
<strong>Type:</strong> ${position.type}<br>
<strong>Entry:</strong> ${position.entry}<br>
<strong>Exit:</strong> ${position.exit}<br>
<strong>Volume:</strong> ${position.volume}<br>
<strong>P&L:</strong> ${position.pnl.toFixed(2)}
                `;

                previewDiv.classList.remove('hidden');

                validateComplete(position);

            } catch (error) {
                console.error('Error parsing:', error);
                alert('‚ùå Error al procesar: ' + error.message);
            }
        }

        function validateComplete(parsed) {
            const quickAdd = window.currentQuickAdd;
            const validationDiv = document.getElementById('complete-validation');

            const warnings = [];

            if (parsed.symbol.toUpperCase() !== quickAdd.symbol.toUpperCase()) {
                warnings.push(`‚ö†Ô∏è Symbol diferente: QA=${quickAdd.symbol}, Parsed=${parsed.symbol}`);
            }

            const pnlDiff = Math.abs(parsed.pnl - quickAdd.pnl);
            if (pnlDiff > 1) {
                warnings.push(`‚ö†Ô∏è P&L diferente: QA=${quickAdd.pnl.toFixed(2)}, Parsed=${parsed.pnl.toFixed(2)} (diff: ${pnlDiff.toFixed(2)})`);
            }

            if (warnings.length > 0) {
                validationDiv.innerHTML = `
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                        <h5 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Validaci√≥n:</h5>
                        ${warnings.map(w => `<div class="text-sm text-yellow-700">${w}</div>`).join('')}
                        <div class="text-sm text-gray-600 mt-2">Puedes continuar si los datos son correctos</div>
                    </div>
                `;
            } else {
                validationDiv.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                        <div class="text-green-700 font-bold">‚úÖ Validaci√≥n exitosa</div>
                    </div>
                `;
            }
            validationDiv.classList.remove('hidden');
        }

        async function executeComplete() {
            const brokerData = document.getElementById('complete-broker-data').value.trim();
            const quickAdd = window.currentQuickAdd;

            if (!brokerData || !quickAdd) {
                alert('Datos incompletos');
                return;
            }

            try {
                // Parse broker data
                const parsed = parseRawData(brokerData);

                if (!parsed || parsed.length === 0) {
                    alert('‚ùå No se pudo procesar los datos');
                    return;
                }

                const position = parsed[0];

                // Close complete modal
                closeCompleteModal();

                // Create a trade object for Step 3 (similar to detection result)
                currentTrade = {
                    orderID: position.orderID || quickAdd.orderID,
                    symbol: position.symbol,
                    type: position.type,
                    entry: position.entry,
                    exit: position.exit,
                    volume: position.volume,
                    pnl: position.pnl,
                    timeBRT: position.timeBRT,
                    openHourBRT: position.openHourBRT,
                    isGrouped: false,
                    positions: [{
                        entryPrice: position.entry,
                        exitPrice: position.exit,
                        volume: position.volume,
                        pnl: position.pnl
                    }]
                };

                // Store Quick Add info for later update
                window.currentQuickAddCompletion = {
                    quickAddID: quickAdd.orderID,
                    quickAddTimestamp: quickAdd.timestamp
                };

                // Update step indicator
                updateStepIndicator(3);

                // Get next trade number
                const nextTradeNumber = await getNextTradeNumber();

                // Pre-fill form with parsed data
                document.getElementById('trade-number').value = nextTradeNumber;
                document.getElementById('trade-number-hint').textContent = `Sugerido: ${nextTradeNumber} (completando Quick Add)`;

                // Pre-fill Take Profit with exit price
                if (position.exit) {
                    document.getElementById('take-profit').value = position.exit.toFixed(2);
                }

                // Render stop loss inputs
                renderStopLossInputs();

                // Show step 3
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-3').classList.remove('hidden');
                document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'start' });

                showMessage('‚úÖ Datos cargados. Por favor completa Stop Loss y otros campos', 'info');

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ==========================================
        // COMPLETE ALL QUICK ADDS
        // ==========================================

        let matchedTrades = [];

        async function completeAllQuickAdds() {
            try {
                const todayTrades = await StorageManager.getTodayTrades();
                const quickAdds = todayTrades.filter(t => t.isQuickAdd === true);

                if (quickAdds.length === 0) {
                    alert('No hay Quick Adds pendientes');
                    return;
                }

                showCompleteAllModal(quickAdds);

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cargar Quick Adds');
            }
        }

        function showCompleteAllModal(quickAdds) {
            const listDiv = document.getElementById('complete-all-list');
            listDiv.innerHTML = quickAdds.map(qa => `
                <div class="flex items-center justify-between bg-white p-3 rounded border border-blue-200">
                    <span class="font-bold">${qa.symbol}</span>
                    <span class="${qa.pnl >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${qa.pnl >= 0 ? '+' : ''}${qa.pnl.toFixed(2)}</span>
                    <span class="text-sm text-gray-600">${new Date(qa.timestamp).toLocaleTimeString('es-ES')}</span>
                </div>
            `).join('');

            document.getElementById('complete-all-data').value = '';
            document.getElementById('match-results').classList.add('hidden');
            matchedTrades = [];

            document.getElementById('completeAllModal').classList.remove('hidden');
        }

        function closeCompleteAllModal() {
            document.getElementById('completeAllModal').classList.add('hidden');
            matchedTrades = [];
        }

        async function previewCompleteAll() {
            const journalData = document.getElementById('complete-all-data').value.trim();

            if (!journalData) {
                alert('Por favor pega el journal');
                return;
            }

            try {
                const todayTrades = await StorageManager.getTodayTrades();
                const quickAdds = todayTrades.filter(t => t.isQuickAdd === true);

                // Parse journal lines - cada 2 l√≠neas forman un trade completo
                const lines = journalData.split('\n').filter(line => line.trim());
                const parsedTrades = [];

                for (let i = 0; i < lines.length; i += 2) {
                    if (i + 1 < lines.length) {
                        const tradePair = [lines[i], lines[i + 1]].join('\n');
                        try {
                            const parsed = parseRawData(tradePair);
                            if (parsed && parsed.length > 0) {
                                parsedTrades.push(parsed[0]);
                            }
                        } catch (e) {
                            console.warn('Error parsing pair:', e);
                        }
                    }
                }

                // Match Quick Adds con parsed trades
                matchedTrades = [];
                const unmatched = [];

                for (const qa of quickAdds) {
                    let bestMatch = null;
                    let bestScore = 0;

                    for (const parsed of parsedTrades) {
                        let score = 0;

                        if (parsed.symbol.toUpperCase() === qa.symbol.toUpperCase()) {
                            score += 100;
                        }

                        const pnlDiff = Math.abs(parsed.pnl - qa.pnl);
                        const pnlSimilarity = 1 - (pnlDiff / Math.max(Math.abs(qa.pnl), 1));
                        score += pnlSimilarity * 50;

                        if (score > bestScore && !parsed.matched) {
                            bestScore = score;
                            bestMatch = parsed;
                        }
                    }

                    if (bestMatch && bestScore > 80) {
                        bestMatch.matched = true;
                        matchedTrades.push({
                            quickAdd: qa,
                            parsed: bestMatch,
                            score: bestScore
                        });
                    } else {
                        unmatched.push(qa);
                    }
                }

                displayMatchResults(matchedTrades, unmatched);

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        function displayMatchResults(matches, unmatched) {
            const resultsDiv = document.getElementById('match-results');

            let html = '<div class="space-y-4">';

            if (matches.length > 0) {
                html += `
                    <div class="bg-green-50 border-2 border-green-400 rounded-lg p-4">
                        <h5 class="font-bold text-green-800 mb-3">‚úÖ Matches (${matches.length}):</h5>
                        <div class="space-y-2">
                `;

                matches.forEach(m => {
                    html += `
                        <div class="bg-white p-3 rounded border border-green-300">
                            <div class="flex justify-between">
                                <span class="font-bold">${m.quickAdd.symbol}</span>
                                <span class="text-sm">Score: ${m.score.toFixed(0)}%</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                QA: ${m.quickAdd.pnl.toFixed(2)} ‚Üí Parsed: ${m.parsed.pnl.toFixed(2)}
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            if (unmatched.length > 0) {
                html += `
                    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                        <h5 class="font-bold text-yellow-800 mb-3">‚ö†Ô∏è Sin Match (${unmatched.length}):</h5>
                        <div class="space-y-2">
                `;

                unmatched.forEach(qa => {
                    html += `
                        <div class="bg-white p-3 rounded text-sm">
                            ${qa.symbol} - ${qa.pnl >= 0 ? '+' : ''}${qa.pnl.toFixed(2)}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';

            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('hidden');
        }

        async function executeCompleteAll() {
            if (matchedTrades.length === 0) {
                alert('Primero detecta los matches');
                return;
            }

            if (!confirm(`¬øCompletar ${matchedTrades.length} Quick Adds?`)) {
                return;
            }

            try {
                let completed = 0;

                for (const match of matchedTrades) {
                    const completeTrade = {
                        orderID: match.quickAdd.orderID,
                        symbol: match.parsed.symbol,
                        entry: match.parsed.entry,
                        exit: match.parsed.exit,
                        volume: match.parsed.volume,
                        pnl: match.parsed.pnl,
                        type: match.parsed.type,
                        timeBRT: match.parsed.timeBRT,
                        timestamp: match.quickAdd.timestamp,
                        isQuickAdd: false,
                        completedAt: new Date().toISOString()
                    };

                    const success = await StorageManager.updateTrade(match.quickAdd.orderID, completeTrade);
                    if (success) completed++;
                }

                alert(`‚úÖ Completados: ${completed}/${matchedTrades.length}`);
                closeCompleteAllModal();
                await loadPendingQuickAdds();

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ==========================================
        // MOCK window.storage FOR DEVELOPMENT
        // ==========================================
        if (typeof window.storage === 'undefined') {
            console.warn('‚ö†Ô∏è window.storage not available. Using localStorage fallback.');

            window.storage = {
                async get(key) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value } : null;
                },
                async set(key, value) {
                    localStorage.setItem(key, value);
                    return { key, value };
                },
                async delete(key) {
                    localStorage.removeItem(key);
                    return { key, deleted: true };
                }
            };
        }
    </script>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">‚ö° Quick Add Trade</h3>

            <!-- Symbol Selection -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">Symbol</label>
                <input type="text"
                       id="qa-symbol"
                       placeholder="Ej: BTC, ETH, SOL..."
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-lg">
            </div>

            <!-- P&L Input -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">P&L (con signo)</label>
                <input type="number"
                       id="qa-pnl"
                       placeholder="Ej: -50 o +120"
                       step="0.01"
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none text-lg font-mono">
                <p class="text-xs text-gray-500 mt-1">Negativo para p√©rdida, positivo para ganancia</p>
            </div>

            <!-- L√≠mites del D√≠a (Editables) -->
            <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-gray-800 mb-3">‚öôÔ∏è L√≠mites de Hoy:</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Max Daily Loss</label>
                        <input type="number"
                               id="qa-max-loss"
                               placeholder="400"
                               step="50"
                               onchange="saveLimitsOnChange()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Max Trades</label>
                        <input type="number"
                               id="qa-max-trades"
                               placeholder="5"
                               min="1"
                               max="20"
                               onchange="saveLimitsOnChange()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-green-500 focus:outline-none">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">üí° Se cargan del Daily Plan si existe, o puedes editarlos aqu√≠</p>
            </div>

            <!-- Running Totals -->
            <div id="qa-running-totals" class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-blue-900 mb-3">üìä Running Totals Hoy:</h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-700">P&L Acumulado:</span>
                        <span id="qa-total-pnl" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-700">Trades:</span>
                        <span id="qa-trade-count" class="font-bold">0 / 5</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-700">L√≠mite restante:</span>
                        <span id="qa-remaining" class="font-bold">$400</span>
                    </div>
                </div>
                <div id="qa-warning" class="hidden mt-3 p-2 bg-yellow-100 border border-yellow-400 rounded text-xs text-yellow-800">
                    ‚ö†Ô∏è Te est√°s acercando al l√≠mite
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button onclick="saveQuickAdd()"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition-all">
                    üíæ Guardar
                </button>
                <button onclick="closeQuickAddModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold transition-all">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Complete Quick Add Modal -->
    <div id="completeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">‚úèÔ∏è Completar Quick Add</h3>

            <!-- Quick Add Info -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-sm text-gray-600">Symbol</div>
                        <div id="complete-symbol" class="text-xl font-bold text-gray-800"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">P&L Original</div>
                        <div id="complete-pnl" class="text-xl font-bold"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Timestamp</div>
                        <div id="complete-time" class="text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <p class="text-sm text-gray-700">
                    üìã <strong>Instrucciones:</strong> Pega las l√≠neas del broker para este trade.
                    El sistema detectar√° autom√°ticamente el formato (tabla o texto) y agrupar√° las posiciones.
                </p>
            </div>

            <!-- Textarea for broker data -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Datos del Broker
                </label>
                <textarea id="complete-broker-data"
                          rows="8"
                          placeholder="Pega aqu√≠ las 2 l√≠neas del trade (Opening + Closing):

ETHUSD  04/11/25 00.34  329850645  Buy   Opening  3.80  3,643.15  -0.08
ETHUSD  04/11/25 00.36  329851941  Sell  Closing  3.80  3,643.13  -0.08"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-sm">
                </textarea>
            </div>

            <!-- Parse result preview -->
            <div id="parse-preview" class="hidden mb-6">
                <h4 class="font-bold text-gray-800 mb-3">üìä Preview:</h4>
                <div id="parse-preview-content" class="bg-gray-50 border border-gray-300 rounded-lg p-4 text-sm">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Validation alerts -->
            <div id="complete-validation" class="hidden mb-6">
                <!-- Populated by JS -->
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button onclick="previewComplete()"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition-all">
                    üëÅÔ∏è Preview
                </button>
                <button onclick="executeComplete()"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition-all">
                    ‚úÖ Completar Trade
                </button>
                <button onclick="closeCompleteModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold transition-all">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Complete All Quick Adds Modal -->
    <div id="completeAllModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã Completar Todos los Quick Adds</h3>

            <!-- Quick Adds List -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-blue-900 mb-3">Quick Adds Pendientes:</h4>
                <div id="complete-all-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <p class="text-sm text-gray-700">
                    üìã <strong>Instrucciones:</strong> Pega TODAS las l√≠neas del journal del broker.
                    El sistema autom√°ticamente har√° match con cada Quick Add por s√≠mbolo y P&L.
                </p>
            </div>

            <!-- Textarea -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Journal Completo del Broker
                </label>
                <textarea id="complete-all-data"
                          rows="12"
                          placeholder="Pega aqu√≠ TODAS las l√≠neas de trades del d√≠a...

ETHUSD  04/11/25 00.34  329850645  Buy   Opening  3.80  3,643.15  -0.08
ETHUSD  04/11/25 00.36  329851941  Sell  Closing  3.80  3,643.13  -0.08
BTCUSD  03/11/25 23.27  329807962  Buy   Opening  0.251  107,161.4  -111.40
BTCUSD  03/11/25 23.42  329815611  Sell  Closing  0.251  106,717.6  -111.40"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-sm">
                </textarea>
            </div>

            <!-- Match results -->
            <div id="match-results" class="hidden mb-6">
                <!-- Populated by JS -->
            </div>

            <!-- Buttons -->
            <div class="flex gap-3">
                <button onclick="previewCompleteAll()"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition-all">
                    üîç Detectar Matches
                </button>
                <button onclick="executeCompleteAll()"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold transition-all">
                    ‚úÖ Completar Todos
                </button>
                <button onclick="closeCompleteAllModal()"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold transition-all">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

</body>

</html>