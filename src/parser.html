<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Parser</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy-dark': '#1e3a5f',
                        'navy-medium': '#2c5282',
                        'blue-primary': '#3b5998',
                        'blue-hover': '#2d4373',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .processing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Step indicator */
        .step-active {
            background: #3b5998;
            color: white;
        }

        .step-completed {
            background: #10b981;
            color: white;
        }

        .step-inactive {
            background: #e2e8f0;
            color: #64748b;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-navy-dark text-white px-6 py-3 flex justify-between items-center shadow-lg no-print">
        <div class="flex items-center gap-6">
            <h1 class="text-lg font-bold">TRADE PARSER</h1>
            <div class="flex gap-4 text-sm">
                <a href="daily-plan.html" class="hover:text-blue-300 transition-colors">üìã Daily Plan</a>
                <a href="parser.html" class="text-blue-300 font-semibold">‚öôÔ∏è Parser</a>
                <a href="dashboard.html" class="hover:text-blue-300 transition-colors">üìä Dashboard</a>
            </div>
        </div>
        <div class="text-sm text-slate-300" id="current-date"></div>
    </nav>

    <!-- Status Message -->
    <div id="status-message" class="hidden slide-in max-w-7xl mx-auto mt-4 px-4">
        <!-- Content injected via JS -->
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-4 py-6">

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- ============================================ -->
            <!-- SIDEBAR: Daily Plan Summary -->
            <!-- ============================================ -->
            <aside class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg border border-slate-200 sticky top-6">
                    <div class="bg-blue-primary text-white px-4 py-3 rounded-t-lg">
                        <h2 class="font-semibold text-sm uppercase tracking-wide">üìã Tu Plan de Hoy</h2>
                    </div>

                    <div class="p-4 space-y-4" id="plan-summary">
                        <!-- Loaded via JS -->
                        <div class="text-center py-8 text-slate-400 text-sm">
                            <p>Cargando plan...</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ============================================ -->
            <!-- MAIN CONTENT: Parser Steps -->
            <!-- ============================================ -->
            <main class="lg:col-span-3 space-y-6">

                <!-- Step Indicator -->
                <div class="bg-white rounded-lg shadow-lg border border-slate-200 p-6">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div
                                class="step-active w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                1</div>
                            <span class="text-sm font-medium text-slate-700">Pegar Datos</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                2</div>
                            <span class="text-sm font-medium text-slate-700">Detectar</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                3</div>
                            <span class="text-sm font-medium text-slate-700">Completar</span>
                        </div>
                        <div class="h-px bg-slate-300 flex-1 mx-3"></div>

                        <div class="flex items-center gap-2">
                            <div
                                class="step-inactive w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                4</div>
                            <span class="text-sm font-medium text-slate-700">Guardar</span>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- STEP 1: Paste Data -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200" id="step-1">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">üìä Paso 1: Pegar Datos
                            de la Plataforma</h3>
                    </div>

                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                Pega aqu√≠ los datos del trade (Formato Funding):
                            </label>
                            <textarea id="raw-data" rows="12" placeholder="Ejemplo:
323002810	2024-10-28 19:59:17	SOLUSD	Short	197.96	196.13	1.83	12	21.96	Funding"
                                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent font-mono text-sm resize-none"></textarea>
                            <p class="text-xs text-slate-500 mt-2">
                                üí° Formato esperado: Order ID, Time (UTC), Symbol, Side, Entry, Exit, PnL per unit,
                                Volume, PnL total, Type
                            </p>
                        </div>

                        <div class="flex justify-between items-center">
                            <button onclick="clearRawData()"
                                class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                                üîÑ Limpiar
                            </button>

                            <button onclick="detectTrades()"
                                class="px-6 py-2.5 bg-blue-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-hover transition-all shadow-lg">
                                üîç Detectar Trades ‚Üí
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 2: Detection Results (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-2">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">üîç Paso 2: Trades
                            Detectados</h3>
                    </div>

                    <div class="p-6" id="detection-results">
                        <!-- Populated via JS -->
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 3: Complete Trade Data (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-3">
                    <div class="bg-slate-100 px-6 py-3 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-700 uppercase text-sm tracking-wide">‚úçÔ∏è Paso 3: Completar
                            Datos del Trade</h3>
                    </div>

                    <div class="p-6">
                        <form id="trade-form" class="space-y-6">

                            <!-- Trade Number and Block -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="trade-number" class="block text-sm font-medium text-slate-700 mb-2">
                                        Trade Number <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" id="trade-number" name="tradeNumber" required
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                    <p class="text-xs text-slate-500 mt-1" id="trade-number-hint"></p>
                                </div>

                                <div>
                                    <label for="block" class="block text-sm font-medium text-slate-700 mb-2">
                                        Block
                                    </label>
                                    <input type="number" id="block" name="block" value="1"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                </div>
                            </div>

                            <!-- Stop Loss and Take Profit (Dynamic based on trade type) -->
                            <div id="stop-loss-container">
                                <!-- Will be filled dynamically by renderStopLossInputs() -->
                            </div>

                            <!-- Take Profit -->
                            <div>
                                <label for="take-profit" class="block text-sm font-medium text-slate-700 mb-2">
                                    Take Profit <span class="text-slate-400 text-xs">(opcional)</span>
                                </label>
                                <input type="number" step="0.01" id="take-profit" name="takeProfit"
                                    placeholder="0.00"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                <p class="text-xs text-slate-500 mt-1">
                                    üí° Auto-relleno con exit price. Modif√≠calo si es necesario.
                                </p>
                            </div>

                            <!-- Planned Risk -->
                            <div>
                                <label for="risk-planned" class="block text-sm font-medium text-slate-700 mb-2">
                                    Riesgo Planeado <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-slate-400">$</span>
                                    <input type="number" step="0.01" id="risk-planned" name="riskPlanned" required
                                        placeholder="100.00"
                                        class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Riesgo que planeaste antes de entrar al trade
                                </p>
                            </div>

                            <!-- Item (Setup) -->
                            <div>
                                <label for="item" class="block text-sm font-medium text-slate-700 mb-2">
                                    √çtem (Setup)
                                </label>
                                <input type="text" id="item" name="item"
                                    placeholder="e.g. Setup limpio, Reversi√≥n en soporte"
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent">
                            </div>

                            <!-- Observation -->
                            <div>
                                <label for="observation" class="block text-sm font-medium text-slate-700 mb-2">
                                    Observaci√≥n
                                </label>
                                <textarea id="observation" name="observation" rows="3"
                                    placeholder="Notas sobre el trade: emociones, ejecuci√≥n, lo que aprendiste..."
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent resize-none"></textarea>
                            </div>

                            <!-- Plan Compliance -->
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                <h4 class="text-sm font-semibold text-slate-700 mb-3">Cumplimiento del Plan</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="followed-plan" name="followedPlan" checked
                                            class="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-500">
                                        <span class="text-sm text-slate-700">‚úÖ Segu√≠ el plan</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" id="broke-rules" name="brokeRules"
                                            class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                                        <span class="text-sm text-slate-700">‚ùå Romp√≠ reglas</span>
                                    </label>
                                </div>
                                <div id="rules-violated-container" class="mt-3 hidden">
                                    <label class="block text-xs font-medium text-slate-700 mb-2">¬øQu√© reglas
                                        rompiste?</label>
                                    <textarea id="rules-violated" name="rulesViolated" rows="2"
                                        placeholder="Especifica qu√© reglas no seguiste..."
                                        class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-primary resize-none"></textarea>
                                </div>
                            </div>

                            <!-- Calculated Metrics Preview -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-900 mb-3">üìä M√©tricas Calculadas (Preview)
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                    <div>
                                        <p class="text-blue-700 font-medium">Riesgo Ejecutado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-risk-executed">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">Desviaci√≥n</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-risk-deviation">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">R Planeado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-r-planned">--</p>
                                    </div>
                                    <div>
                                        <p class="text-blue-700 font-medium">R Ejecutado</p>
                                        <p class="text-lg font-bold text-blue-900" id="preview-r-executed">--</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Local Error Message (hidden by default) -->
                            <div id="form-error-message" class="hidden mb-4 slide-in"></div>

                            <!-- Action Buttons -->
                            <div class="flex justify-between items-center pt-4 border-t border-slate-200">
                                <button type="button" onclick="goBackToDetection()"
                                    class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                                    ‚Üê Volver
                                </button>

                                <button type="submit"
                                    class="px-6 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-all shadow-lg">
                                    üíæ Guardar Trade
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- STEP 4: Success & Outputs (Hidden initially) -->
                <!-- ============================================ -->
                <section class="bg-white rounded-lg shadow-lg border border-slate-200 hidden" id="step-4">
                    <div class="bg-green-50 px-6 py-3 border-b border-green-200">
                        <h3 class="font-semibold text-green-800 uppercase text-sm tracking-wide">‚úÖ Trade Guardado
                            Exitosamente</h3>
                    </div>

                    <div class="p-6 space-y-6">

                        <!-- Telegram Template -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">üì± Plantilla
                                Telegram:</label>
                            <div class="bg-slate-50 border border-slate-300 rounded-lg p-4 font-mono text-sm">
                                <pre id="telegram-output" class="whitespace-pre-wrap text-slate-800"></pre>
                            </div>
                            <button onclick="copyToClipboard('telegram-output')"
                                class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-all">
                                üìã Copiar
                            </button>
                        </div>

                        <!-- CSV Line -->
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">üìÑ L√≠nea CSV:</label>
                            <div
                                class="bg-slate-50 border border-slate-300 rounded-lg p-4 font-mono text-xs overflow-x-auto">
                                <pre id="csv-output" class="whitespace-nowrap text-slate-800"></pre>
                            </div>
                            <button onclick="copyToClipboard('csv-output')"
                                class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-all">
                                üìã Copiar
                            </button>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-center gap-4 pt-4 border-t border-slate-200">
                            <button onclick="resetParser()"
                                class="px-6 py-2.5 bg-blue-primary text-white rounded-lg text-sm font-semibold hover:bg-blue-hover transition-all">
                                ‚ûï Registrar Otro Trade
                            </button>
                            <a href="dashboard.html"
                                class="px-6 py-2.5 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-all inline-block">
                                üìä Ver Dashboard
                            </a>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            timezone: 'America/Sao_Paulo', // BRT
            storageKeys: {
                trades: 'trades-data',
                dailyPlan: 'daily-plan-today'
            }
        };

        // Global state
        let detectedTrades = [];
        let currentTrade = null;
        let dailyPlan = null;

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.addEventListener('DOMContentLoaded', async function () {
            setCurrentDate();
            await loadDailyPlan();
            setupEventListeners();

            console.log('‚úÖ Parser initialized');
        });

        function setCurrentDate() {
            const today = new Date();
            const options = {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric',
                timeZone: CONFIG.timezone
            };
            const dateStr = today.toLocaleDateString('en-US', options);
            document.getElementById('current-date').textContent = dateStr;
        }

        // ==========================================
        // LOAD DAILY PLAN
        // ==========================================
        async function loadDailyPlan() {
            try {
                const result = await window.storage.get(CONFIG.storageKeys.dailyPlan);

                if (result && result.value) {
                    dailyPlan = JSON.parse(result.value);
                    renderPlanSummary(dailyPlan);
                } else {
                    renderNoPlan();
                }
            } catch (error) {
                console.error('Error loading daily plan:', error);
                renderNoPlan();
            }
        }

        function renderPlanSummary(plan) {
            const container = document.getElementById('plan-summary');

            container.innerHTML = `
        <div class="space-y-3">
          <div class="pb-3 border-b border-slate-200">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Setup del d√≠a</p>
            <p class="text-sm text-slate-700 leading-snug">${plan.aSetup || 'No definido'}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
              <p class="text-xs text-slate-500 font-medium">Max Trades</p>
              <p class="text-lg font-bold text-slate-800">${plan.maxTrades || '5'}</p>
            </div>
            <div>
              <p class="text-xs text-slate-500 font-medium">Max Loss</p>
              <p class="text-lg font-bold text-slate-800">$${plan.maxDailyLoss || '250'}</p>
            </div>
          </div>
          
          <div class="bg-amber-50 border border-amber-200 rounded p-3">
            <p class="text-xs font-semibold text-amber-900 mb-2">‚ö†Ô∏è Circuit Breakers</p>
            <div class="space-y-1 text-xs text-amber-800">
              ${plan.circuitBreakers?.twoLosses ? '<p>‚úì 2 losses = 30min break</p>' : ''}
              ${plan.circuitBreakers?.threeLosses ? '<p>‚úì 3 losses = done for day</p>' : ''}
              ${plan.circuitBreakers?.maxHit ? '<p>‚úì Max hit = close all</p>' : ''}
            </div>
          </div>
          
          <div class="pt-3 border-t border-slate-200">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Estado Mental</p>
            <p class="text-sm font-medium text-slate-700">${plan.mentalState || 'No registrado'}</p>
          </div>
        </div>
      `;
        }

        function renderNoPlan() {
            const container = document.getElementById('plan-summary');
            container.innerHTML = `
        <div class="text-center py-6">
          <p class="text-sm text-slate-500 mb-3">‚ö†Ô∏è No hay plan para hoy</p>
          <a href="daily-plan.html" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
            Crear plan ‚Üí
          </a>
        </div>
      `;
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        function setupEventListeners() {
            // Show/hide rules violated textarea
            document.getElementById('broke-rules').addEventListener('change', function () {
                const container = document.getElementById('rules-violated-container');
                container.classList.toggle('hidden', !this.checked);
            });

            // Real-time calculation preview
            // Note: stop-loss is now dynamic and handled by renderStopLossInputs()
            const calculationInputs = ['take-profit', 'risk-planned'];
            calculationInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculationPreview);
            });

            // Form submission
            document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
        }

        // ==========================================
        // STEP 1: CLEAR RAW DATA
        // ==========================================
        function clearRawData() {
            document.getElementById('raw-data').value = '';
            showMessage('Textarea limpiado', 'info');
        }

        // ==========================================
        // STEP 2: DETECT TRADES
        // ==========================================
        async function detectTrades() {
            const rawData = document.getElementById('raw-data').value.trim();

            if (!rawData) {
                showMessage('Por favor pega los datos del trade primero', 'warning');
                return;
            }

            showMessage('üîç Detectando trades...', 'info');
            updateStepIndicator(2);

            try {
                // Parse all positions
                const allPositions = parseRawData(rawData);

                if (allPositions.length === 0) {
                    throw new Error('No se detectaron posiciones v√°lidas');
                }

                // Group positions into trades
                detectedTrades = groupPositions(allPositions);

                if (detectedTrades.length === 0) {
                    throw new Error('No se pudieron agrupar las posiciones');
                }

                // Show detection results
                renderDetectionResults(detectedTrades);

                // Show step 2
                document.getElementById('step-2').classList.remove('hidden');
                document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });

                const totalPositions = allPositions.length;
                const groupedCount = detectedTrades.filter(t => t.isGrouped).length;

                if (groupedCount > 0) {
                    showMessage(`‚úÖ ${detectedTrades.length} trade(s) detectado(s) de ${totalPositions} posici√≥n(es) - ${groupedCount} agrupado(s)`, 'success');
                } else {
                    showMessage(`‚úÖ ${detectedTrades.length} trade(s) detectado(s)`, 'success');
                }

            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }

        function parseRawData(rawData) {
            const lines = rawData.split('\n').filter(l => l.trim());
            const positions = [];

            for (const line of lines) {
                // Split by tab or multiple spaces
                const parts = line.split(/\t+|\s{2,}/);

                if (parts.length < 9) {
                    console.warn('L√≠nea ignorada (formato inv√°lido):', line);
                    continue;
                }

                try {
                    const position = {
                        orderID: parts[0].trim(),
                        timeUTC: parts[1].trim(),
                        symbol: parts[2].trim(),
                        side: parts[3].trim(),
                        entry: parseFloat(parts[4]),
                        exit: parseFloat(parts[5]),
                        pnlPerUnit: parseFloat(parts[6]),
                        volume: parseFloat(parts[7]) || 0,
                        pnl: parseFloat(parts[8]),
                        rawType: parts[9] ? parts[9].trim() : 'Funding'
                    };

                    // Convert UTC to BRT
                    const utcDate = new Date(position.timeUTC.replace(' ', 'T') + 'Z');
                    const brtDate = new Date(utcDate.toLocaleString('en-US', { timeZone: CONFIG.timezone }));

                    position.timeBRT = brtDate.toISOString().slice(0, 19).replace('T', ' ');
                    position.openHourBRT = brtDate.getHours();

                    // Determine LONG/SHORT
                    position.type = position.side.toLowerCase().includes('long') ? 'LONG' : 'SHORT';

                    positions.push(position);

                } catch (error) {
                    console.warn('Error parseando l√≠nea:', line, error);
                }
            }

            return positions;
        }

        // ==========================================
        // GROUPING LOGIC (v2.0)
        // ==========================================
        function groupPositions(positions) {
            if (positions.length === 0) return [];

            const trades = [];
            const grouped = {};

            // Sort positions by time
            positions.sort((a, b) => new Date(a.timeBRT) - new Date(b.timeBRT));

            for (const pos of positions) {
                // Create group key: symbol + type
                const groupKey = `${pos.symbol}_${pos.type}`;

                if (!grouped[groupKey]) {
                    grouped[groupKey] = [];
                }

                // Check if this position belongs to the last trade in this group
                const currentGroup = grouped[groupKey];

                if (currentGroup.length === 0) {
                    // First position in this group
                    currentGroup.push([pos]);
                } else {
                    const lastTrade = currentGroup[currentGroup.length - 1];
                    const lastPos = lastTrade[lastTrade.length - 1];

                    // Check if positions are related (same exit +/- 0.5%)
                    const exitTolerance = Math.abs(pos.exit - lastPos.exit) / lastPos.exit;

                    // Check time difference (within 4 hours)
                    const timeDiff = Math.abs(new Date(pos.timeBRT) - new Date(lastPos.timeBRT)) / (1000 * 60 * 60);

                    if (exitTolerance <= 0.005 && timeDiff <= 4) {
                        // Add to existing trade
                        lastTrade.push(pos);
                    } else {
                        // Start new trade
                        currentGroup.push([pos]);
                    }
                }
            }

            // Convert grouped positions to trade objects
            for (const groupKey in grouped) {
                for (const posGroup of grouped[groupKey]) {
                    if (posGroup.length === 1) {
                        // Single position trade
                        const pos = posGroup[0];
                        trades.push({
                            symbol: pos.symbol,
                            type: pos.type,
                            entry: pos.entry,
                            exit: pos.exit,
                            volume: pos.volume,
                            pnl: pos.pnl,
                            timeBRT: pos.timeBRT,
                            timeUTC: pos.timeUTC,
                            openHourBRT: pos.openHourBRT,
                            orderID: pos.orderID,
                            isGrouped: false,
                            groupCount: 1,
                            positions: [{
                                orderID: pos.orderID,
                                entryPrice: pos.entry,
                                exitPrice: pos.exit,
                                volume: pos.volume,
                                pnl: pos.pnl,
                                timeBRT: pos.timeBRT
                            }]
                        });
                    } else {
                        // Grouped trade - calculate weighted averages
                        const totalVolume = posGroup.reduce((sum, p) => sum + p.volume, 0);
                        const totalPnL = posGroup.reduce((sum, p) => sum + p.pnl, 0);

                        // Weighted average entry
                        const weightedEntry = totalVolume > 0
                            ? posGroup.reduce((sum, p) => sum + (p.entry * p.volume), 0) / totalVolume
                            : posGroup.reduce((sum, p) => sum + p.entry, 0) / posGroup.length;

                        // Weighted average exit
                        const weightedExit = totalVolume > 0
                            ? posGroup.reduce((sum, p) => sum + (p.exit * p.volume), 0) / totalVolume
                            : posGroup.reduce((sum, p) => sum + p.exit, 0) / posGroup.length;

                        // First and last times
                        const firstPos = posGroup[0];
                        const lastPos = posGroup[posGroup.length - 1];

                        trades.push({
                            symbol: firstPos.symbol,
                            type: firstPos.type,
                            entry: parseFloat(weightedEntry.toFixed(2)),
                            exit: parseFloat(weightedExit.toFixed(2)),
                            volume: totalVolume,
                            pnl: totalPnL,
                            timeBRT: firstPos.timeBRT,
                            timeUTC: firstPos.timeUTC,
                            openHourBRT: firstPos.openHourBRT,
                            orderID: posGroup.map(p => p.orderID).join(';'),
                            isGrouped: true,
                            groupCount: posGroup.length,
                            positions: posGroup.map(p => ({
                                orderID: p.orderID,
                                entryPrice: p.entry,
                                exitPrice: p.exit,
                                volume: p.volume,
                                pnl: p.pnl,
                                timeBRT: p.timeBRT
                            }))
                        });
                    }
                }
            }

            return trades;
        }

        function renderDetectionResults(trades) {
            const container = document.getElementById('detection-results');

            let html = '<div class="space-y-4">';

            trades.forEach((trade, index) => {
                const profitClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';

                if (trade.isGrouped) {
                    // Render grouped trade
                    html += `
          <div class="border-2 border-blue-300 bg-blue-50 rounded-lg p-4 hover:border-blue-400 transition-colors">
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded">
                    üìä ${trade.groupCount} POSICIONES
                  </span>
                  <h4 class="font-bold text-slate-800">${trade.symbol} <span class="text-sm font-normal ${trade.type === 'LONG' ? 'text-green-600' : 'text-red-600'}">${trade.type}</span></h4>
                </div>
                <p class="text-xs text-slate-500">Order IDs: ${trade.orderID}</p>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold ${profitClass}">$${trade.pnl.toFixed(2)}</p>
                <p class="text-xs text-slate-500">Total PnL</p>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
              <div>
                <p class="text-xs text-slate-500">Avg Entry</p>
                <p class="font-semibold text-slate-700">${trade.entry}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Avg Exit</p>
                <p class="font-semibold text-slate-700">${trade.exit}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Total Volume</p>
                <p class="font-semibold text-slate-700">${trade.volume}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">First Entry</p>
                <p class="font-semibold text-slate-700">${trade.timeBRT.split(' ')[1].slice(0, 5)}</p>
              </div>
            </div>

            <div class="bg-white rounded border border-blue-200 p-3 mb-3">
              <p class="text-xs font-semibold text-slate-600 mb-2">Posiciones detectadas:</p>
              <div class="space-y-1 text-xs">
                ${trade.positions.map((pos, i) => {
                    const posProfitClass = pos.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                    return `<div class="flex justify-between">
                      <span class="text-slate-600">‚îú‚îÄ ${pos.entryPrice} (Vol: ${pos.volume})</span>
                      <span class="font-semibold ${posProfitClass}">${pos.pnl >= 0 ? '+' : ''}$${pos.pnl.toFixed(2)}</span>
                    </div>`;
                }).join('')}
              </div>
            </div>

            <button
              onclick="selectTradeForCompletion(${index})"
              class="w-full px-4 py-2 bg-blue-primary text-white rounded-lg text-sm font-medium hover:bg-blue-hover transition-all"
            >
              ‚úçÔ∏è Completar este Trade
            </button>
          </div>
        `;
                } else {
                    // Render simple trade
                    html += `
          <div class="border border-slate-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-slate-800">${trade.symbol} <span class="text-sm font-normal ${trade.type === 'LONG' ? 'text-green-600' : 'text-red-600'}">${trade.type}</span></h4>
                <p class="text-xs text-slate-500">Order ID: ${trade.orderID}</p>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold ${profitClass}">$${trade.pnl.toFixed(2)}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
              <div>
                <p class="text-xs text-slate-500">Entry</p>
                <p class="font-semibold text-slate-700">${trade.entry}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Exit</p>
                <p class="font-semibold text-slate-700">${trade.exit}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Volume</p>
                <p class="font-semibold text-slate-700">${trade.volume}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500">Time (BRT)</p>
                <p class="font-semibold text-slate-700">${trade.timeBRT.split(' ')[1].slice(0, 5)}</p>
              </div>
            </div>

            <button
              onclick="selectTradeForCompletion(${index})"
              class="w-full px-4 py-2 bg-blue-primary text-white rounded-lg text-sm font-medium hover:bg-blue-hover transition-all"
            >
              ‚úçÔ∏è Completar este Trade
            </button>
          </div>
        `;
                }
            });

            html += '</div>';

            container.innerHTML = html;
        }

        // ==========================================
        // STEP 3: SELECT TRADE FOR COMPLETION
        // ==========================================
        async function selectTradeForCompletion(index) {
            currentTrade = detectedTrades[index];

            updateStepIndicator(3);

            // Get next trade number
            const nextTradeNumber = await getNextTradeNumber();

            // Pre-fill form
            document.getElementById('trade-number').value = nextTradeNumber;
            document.getElementById('trade-number-hint').textContent = `Sugerido: ${nextTradeNumber} (√∫ltimo trade registrado: ${nextTradeNumber - 1})`;

            // Pre-fill Take Profit with exitPrice
            if (currentTrade.exit) {
                document.getElementById('take-profit').value = currentTrade.exit.toFixed(2);
            }

            // Render stop loss inputs based on trade type
            renderStopLossInputs();

            // Show step 3
            document.getElementById('step-3').classList.remove('hidden');
            document.getElementById('step-3').scrollIntoView({ behavior: 'smooth', block: 'start' });

            showMessage('‚úçÔ∏è Completa los datos del trade', 'info');
        }

        // ==========================================
        // RENDER STOP LOSS INPUTS (v2.0)
        // ==========================================
        function renderStopLossInputs() {
            const container = document.getElementById('stop-loss-container');

            if (!currentTrade) return;

            if (currentTrade.isGrouped) {
                // Render stops for each position + apply to all button
                let html = `
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-slate-700 mb-3">
                            üìä Trade Agrupado: ${currentTrade.groupCount} Posiciones
                        </h4>
                        <div class="space-y-3">
                `;

                currentTrade.positions.forEach((pos, index) => {
                    html += `
                        <div class="bg-white border border-slate-200 rounded p-3">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-medium text-slate-600">
                                    Posici√≥n ${index + 1}: Entry ${pos.entryPrice} (Vol: ${pos.volume})
                                </p>
                                <p class="text-xs font-semibold ${pos.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${pos.pnl >= 0 ? '+' : ''}$${pos.pnl.toFixed(2)}
                                </p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Stop Loss <span class="text-red-500">*</span></label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        id="pos-${index}-stop"
                                        data-position-index="${index}"
                                        placeholder="0.00"
                                        oninput="onStopChange(${index})"
                                        class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-primary"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Risk</label>
                                    <p class="text-sm font-bold text-slate-700 px-3 py-2 bg-slate-100 rounded" id="pos-${index}-risk">--</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-300">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                                <p class="text-xs font-semibold text-blue-900 mb-2">üîó Aplicar mismo stop a todas las posiciones</p>
                                <div class="flex gap-2">
                                    <input
                                        type="number"
                                        step="0.01"
                                        id="apply-stop-input"
                                        placeholder="Stop Loss"
                                        class="flex-1 px-3 py-2 border border-blue-300 rounded text-sm focus:ring-2 focus:ring-blue-primary"
                                    >
                                    <button
                                        type="button"
                                        onclick="applyStopToAll()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition-all"
                                    >
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-slate-500 mb-1">Risk Ejecutado Total</p>
                                <p class="text-2xl font-bold text-slate-800" id="total-risk-executed">$0.00</p>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } else {
                // Render single stop loss input
                let html = `
                    <div>
                        <label for="stop-loss" class="block text-sm font-medium text-slate-700 mb-2">
                            Stop Loss <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="number"
                            step="0.01"
                            id="stop-loss"
                            name="stopLoss"
                            required
                            placeholder="0.00"
                            oninput="updateCalculationPreview()"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-primary focus:border-transparent"
                        >
                    </div>
                `;

                container.innerHTML = html;
            }
        }

        // ==========================================
        // POSITION STOP CHANGE HANDLERS (v2.0)
        // ==========================================
        function onStopChange(positionIndex) {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const position = currentTrade.positions[positionIndex];
            const stopInput = document.getElementById(`pos-${positionIndex}-stop`);
            const stop = parseFloat(stopInput.value);

            if (isNaN(stop) || stop === 0) {
                document.getElementById(`pos-${positionIndex}-risk`).textContent = '--';
                updateTotalRisk();
                return;
            }

            // Calculate risk for this position
            const riskPerUnit = Math.abs(position.entryPrice - stop);
            const risk = riskPerUnit * position.volume;

            // Update display
            document.getElementById(`pos-${positionIndex}-risk`).textContent = `$${risk.toFixed(2)}`;

            // Save in object
            position.stopLoss = stop;
            position.riskPerUnit = riskPerUnit;
            position.riskExecuted = risk;

            // Recalculate total
            updateTotalRisk();
            updateCalculationPreview();
        }

        function updateTotalRisk() {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const totalRisk = currentTrade.positions.reduce(
                (sum, p) => sum + (p.riskExecuted || 0),
                0
            );

            document.getElementById('total-risk-executed').textContent = `$${totalRisk.toFixed(2)}`;

            currentTrade.riskExecuted = totalRisk;
        }

        function applyStopToAll() {
            if (!currentTrade || !currentTrade.isGrouped) return;

            const stopValue = document.getElementById('apply-stop-input').value;
            const stop = parseFloat(stopValue);

            if (isNaN(stop) || stop === 0) {
                showMessage('Ingresa un stop v√°lido', 'warning');
                return;
            }

            // Apply to all positions
            currentTrade.positions.forEach((position, index) => {
                document.getElementById(`pos-${index}-stop`).value = stop;
                onStopChange(index);
            });

            showMessage(`Stop ${stop} aplicado a todas las posiciones`, 'success');
        }

        async function getNextTradeNumber() {
            try {
                const result = await window.storage.get(CONFIG.storageKeys.trades);

                if (result && result.value) {
                    const data = JSON.parse(result.value);
                    if (data.trades && data.trades.length > 0) {
                        const maxTradeNumber = Math.max(...data.trades.map(t => t.tradeNumber));
                        return maxTradeNumber + 1;
                    }
                }
            } catch (error) {
                console.error('Error getting next trade number:', error);
            }

            return 1; // First trade
        }

        function goBackToDetection() {
            document.getElementById('step-3').classList.add('hidden');
            updateStepIndicator(2);
            document.getElementById('step-2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==========================================
        // CALCULATION PREVIEW (v2.0)
        // ==========================================
        function updateCalculationPreview() {
            if (!currentTrade) return;

            const riskPlanned = parseFloat(document.getElementById('risk-planned').value) || 0;

            let riskExecuted = 0;

            if (currentTrade.isGrouped) {
                // Use total risk from positions
                riskExecuted = currentTrade.riskExecuted || 0;
            } else {
                // Calculate from single stop loss
                const stopLossInput = document.getElementById('stop-loss');
                if (!stopLossInput) return;

                const stopLoss = parseFloat(stopLossInput.value) || 0;
                if (!stopLoss) return;

                const entry = currentTrade.entry;
                const volume = currentTrade.volume;
                const riskPerUnit = Math.abs(entry - stopLoss);
                riskExecuted = riskPerUnit * volume;
            }

            if (!riskPlanned || riskExecuted === 0) {
                // Reset preview
                document.getElementById('preview-risk-executed').textContent = '--';
                document.getElementById('preview-risk-deviation').textContent = '--';
                document.getElementById('preview-r-planned').textContent = '--';
                document.getElementById('preview-r-executed').textContent = '--';
                return;
            }

            // Calculate deviation
            const deviation = riskExecuted - riskPlanned;
            const deviationPercent = ((deviation / riskPlanned) * 100).toFixed(1);

            // Calculate R values
            const rPlanned = riskPlanned > 0 ? (currentTrade.pnl / riskPlanned).toFixed(2) : '0.00';
            const rExecuted = riskExecuted > 0 ? (currentTrade.pnl / riskExecuted).toFixed(2) : '0.00';

            // Update preview
            document.getElementById('preview-risk-executed').textContent = `$${riskExecuted.toFixed(2)}`;
            document.getElementById('preview-risk-deviation').textContent = `${deviation > 0 ? '+' : ''}$${deviation.toFixed(2)} (${deviationPercent > 0 ? '+' : ''}${deviationPercent}%)`;
            document.getElementById('preview-r-planned').textContent = `${rPlanned}R`;
            document.getElementById('preview-r-executed').textContent = `${rExecuted}R`;
        }

        // ==========================================
        // STEP 4: SAVE TRADE
        // ==========================================
        async function handleTradeSubmit(e) {
            e.preventDefault();

            // Clear previous errors
            hideFormError();

            if (!currentTrade) {
                showMessage('‚ùå Error: No hay trade seleccionado', 'error');
                return;
            }

            showMessage('üíæ Guardando trade...', 'info');

            try {
                // Build complete trade object
                const formData = new FormData(e.target);
                const completeTrade = buildCompleteTrade(currentTrade, formData);

                // Validate against daily plan
                const validation = validateAgainstPlan(completeTrade);
                if (!validation.valid) {
                    if (!confirm(validation.message + '\n\n¬øGuardar de todos modos?')) {
                        return;
                    }
                }

                // Save to storage
                const saveResult = await saveTrade(completeTrade);

                if (!saveResult.success) {
                    throw new Error(saveResult.error);
                }

                // Generate outputs
                generateOutputs(completeTrade);

                // Show success step
                updateStepIndicator(4);
                document.getElementById('step-3').classList.add('hidden');
                document.getElementById('step-4').classList.remove('hidden');
                document.getElementById('step-4').scrollIntoView({ behavior: 'smooth', block: 'start' });

                showMessage('‚úÖ Trade guardado exitosamente', 'success');

            } catch (error) {
                showFormError(error.message);
                console.error(error);
            }
        }

        function buildCompleteTrade(detectedTrade, formData) {
            const takeProfitValue = formData.get('takeProfit');
            const takeProfit = takeProfitValue ? parseFloat(takeProfitValue) : null;
            const riskPlanned = parseFloat(formData.get('riskPlanned'));

            let stopLoss, riskExecuted, positions, orderIDs;

            if (detectedTrade.isGrouped) {
                // For grouped trades, use positions data
                positions = detectedTrade.positions.map(p => ({
                    ...p,
                    stopLoss: p.stopLoss,
                    takeProfit: takeProfit,
                    riskPerUnit: p.riskPerUnit,
                    riskExecuted: p.riskExecuted
                }));

                // Calculate average stop loss
                stopLoss = positions.reduce((sum, p) => sum + p.stopLoss, 0) / positions.length;

                // Use total risk from positions
                riskExecuted = detectedTrade.riskExecuted;

                // Collect all order IDs
                orderIDs = detectedTrade.orderID.split(';');

            } else {
                // For simple trades, get stop from form
                stopLoss = parseFloat(formData.get('stopLoss'));

                // Calculate risk executed
                const entry = detectedTrade.entry;
                const volume = detectedTrade.volume;
                const riskPerUnit = Math.abs(entry - stopLoss);
                riskExecuted = riskPerUnit * volume;

                // Single position
                positions = [{
                    orderID: detectedTrade.orderID,
                    entryPrice: detectedTrade.entry,
                    exitPrice: detectedTrade.exit,
                    stopLoss: stopLoss,
                    takeProfit: takeProfit,
                    volume: detectedTrade.volume,
                    pnl: detectedTrade.pnl,
                    timeBRT: detectedTrade.timeBRT,
                    riskPerUnit: riskPerUnit,
                    riskExecuted: riskExecuted
                }];

                orderIDs = [detectedTrade.orderID];
            }

            // Calculate deviation
            const riskDeviation = riskExecuted - riskPlanned;
            const riskDeviationPercent = (riskDeviation / riskPlanned) * 100;

            // Risk deviation flag
            let flag = '‚úì';
            if (Math.abs(riskDeviationPercent) > 20) {
                flag = '‚ùå';
            } else if (Math.abs(riskDeviationPercent) > 10) {
                flag = '‚ö†';
            }

            const rPlanned = riskPlanned > 0 ? detectedTrade.pnl / riskPlanned : 0;
            const rExecuted = riskExecuted > 0 ? detectedTrade.pnl / riskExecuted : 0;

            // Parse rules violated
            let rulesViolated = [];
            if (formData.get('brokeRules') === 'on') {
                const rulesText = formData.get('rulesViolated') || '';
                rulesViolated = rulesText.split('\n').filter(r => r.trim());
            }

            return {
                tradeNumber: parseInt(formData.get('tradeNumber')),
                block: parseInt(formData.get('block')) || 1,
                orderIDs: orderIDs,
                isGrouped: detectedTrade.isGrouped,
                groupCount: detectedTrade.groupCount,
                positions: positions,

                // Times
                openTimeBRT: detectedTrade.timeBRT,
                closeTimeBRT: detectedTrade.timeBRT, // Same for now (we don't have close time from Funding data)
                openTimeUTC: detectedTrade.timeUTC,
                closeTimeUTC: detectedTrade.timeUTC,
                openHourBRT: detectedTrade.openHourBRT,
                openHourRange: getHourRange(detectedTrade.openHourBRT),
                openDayOfWeek: getDayOfWeek(new Date(detectedTrade.timeBRT)),
                duration: 'N/A', // Not available in Funding data
                durationMinutes: 0,

                // Trade data
                symbol: detectedTrade.symbol,
                type: detectedTrade.type,
                entry: detectedTrade.entry,
                exitPrice: detectedTrade.exit,
                stopLoss: parseFloat(stopLoss.toFixed(2)),
                takeProfit: takeProfit,
                volume: detectedTrade.volume,

                // Risk and results
                riskPlanned: riskPlanned,
                riskExecuted: parseFloat(riskExecuted.toFixed(2)),
                riskDeviation: parseFloat(riskDeviation.toFixed(2)),
                riskDeviationFlag: flag,
                result: detectedTrade.pnl,
                rPlanned: parseFloat(rPlanned.toFixed(2)),
                rExecuted: parseFloat(rExecuted.toFixed(2)),

                // Metadata
                item: formData.get('item') || '',
                observation: formData.get('observation') || '',
                followedPlan: formData.get('followedPlan') === 'on',
                brokeRules: formData.get('brokeRules') === 'on',
                rulesViolated: rulesViolated,

                // Volume tracking
                volumeCalculated: false,
                volumeAssumed: false,
                volumeSource: 'platform',

                // Timestamps
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        function getHourRange(hour) {
            if (hour >= 9 && hour < 12) return '9-12';
            if (hour >= 12 && hour < 15) return '12-15';
            if (hour >= 15 && hour < 18) return '15-18';
            return 'other';
        }

        function getDayOfWeek(date) {
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            return days[date.getDay()];
        }

        function validateAgainstPlan(trade) {
            if (!dailyPlan) {
                return { valid: true };
            }

            // Check max trades
            // TODO: Get current trade count from storage

            // Check max loss
            if (trade.result < 0) {
                const maxLoss = parseFloat(dailyPlan.maxDailyLoss) || 0;
                if (Math.abs(trade.result) > maxLoss) {
                    return {
                        valid: false,
                        message: `‚ö†Ô∏è Este trade excede tu max daily loss ($${maxLoss})`
                    };
                }
            }

            return { valid: true };
        }

        async function saveTrade(trade) {
            try {
                // Get existing trades
                let tradesData = {
                    version: '1.0',
                    lastUpdated: new Date().toISOString(),
                    totalTrades: 0,
                    trades: []
                };

                const result = await window.storage.get(CONFIG.storageKeys.trades);
                if (result && result.value) {
                    tradesData = JSON.parse(result.value);
                }

                // Check for duplicates
                const isDuplicate = tradesData.trades.some(t =>
                    t.orderIDs.some(id => trade.orderIDs.includes(id))
                );

                if (isDuplicate) {
                    return {
                        success: false,
                        error: 'Trade duplicado: Order ID ya existe en el sistema'
                    };
                }

                // Add trade
                tradesData.trades.push(trade);
                tradesData.totalTrades = tradesData.trades.length;
                tradesData.lastUpdated = new Date().toISOString();

                // Save
                await window.storage.set(CONFIG.storageKeys.trades, JSON.stringify(tradesData));

                console.log('‚úÖ Trade saved:', trade);

                return {
                    success: true,
                    trade: trade
                };

            } catch (error) {
                console.error('Error in saveTrade:', error);
                return {
                    success: false,
                    error: 'Error guardando en storage: ' + error.message
                };
            }
        }

        function generateOutputs(trade) {
            // Generate Telegram template
            const deviationSign = trade.riskDeviation >= 0 ? '+' : '';
            const deviationPercent = ((trade.riskDeviation / trade.riskPlanned) * 100).toFixed(1);

            let telegram;

            if (trade.isGrouped) {
                // Template for grouped trade
                const positionsText = trade.positions.map(p =>
                    `‚îú‚îÄ ${p.entryPrice} (SL: ${p.stopLoss}) Vol: ${p.volume} ‚Üí ${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(2)}`
                ).join('\n');

                telegram = `
üîπ Trade #${trade.tradeNumber} - ${trade.symbol}
${trade.type === 'LONG' ? 'üìà LONG' : 'üìâ SHORT'} (${trade.groupCount} posiciones)

Avg Entry: ${trade.entry.toFixed(2)}
Avg Exit: ${trade.exitPrice.toFixed(2)}
Stop: ${trade.stopLoss.toFixed(2)}${trade.takeProfit ? ' | TP: ' + trade.takeProfit.toFixed(2) : ''}

Posiciones:
${positionsText}

Riesgo Ejecutado: $${trade.riskExecuted.toFixed(2)}
Total Volume: ${trade.volume}
Result: ${trade.result >= 0 ? '+' : ''}$${trade.result.toFixed(2)}
R Real: ${trade.rExecuted >= 0 ? '+' : ''}${trade.rExecuted.toFixed(2)}R

(Planeado: $${trade.riskPlanned.toFixed(2)} | Desviaci√≥n: ${deviationSign}${deviationPercent}% ${trade.riskDeviationFlag})

${trade.item ? `Setup: ${trade.item}` : ''}
${trade.observation ? `\nNotes: ${trade.observation}` : ''}
                `.trim();
            } else {
                // Template for simple trade
                telegram = `
üîπ Trade #${trade.tradeNumber} - ${trade.symbol}
${trade.type === 'LONG' ? 'üìà LONG' : 'üìâ SHORT'}

Entry: ${trade.entry.toFixed(2)}
Exit: ${trade.exitPrice.toFixed(2)}
SL: ${trade.stopLoss.toFixed(2)}${trade.takeProfit ? ' | TP: ' + trade.takeProfit.toFixed(2) : ''}

Riesgo Ejecutado: $${trade.riskExecuted.toFixed(2)}
Volume: ${trade.volume}
Result: ${trade.result >= 0 ? '+' : ''}$${trade.result.toFixed(2)}
R Real: ${trade.rExecuted >= 0 ? '+' : ''}${trade.rExecuted.toFixed(2)}R

(Planeado: $${trade.riskPlanned.toFixed(2)} | Desviaci√≥n: ${deviationSign}${deviationPercent}% ${trade.riskDeviationFlag})

${trade.item ? `Setup: ${trade.item}` : ''}
${trade.observation ? `\nNotes: ${trade.observation}` : ''}
                `.trim();
            }

            document.getElementById('telegram-output').textContent = telegram;

            // CSV line
            const csv = [
                trade.tradeNumber,
                trade.block,
                trade.orderIDs.join(';'),
                trade.isGrouped,
                trade.groupCount,
                trade.symbol,
                trade.type,
                trade.entry.toFixed(2),
                trade.exitPrice.toFixed(2),
                trade.stopLoss.toFixed(2),
                trade.takeProfit ? trade.takeProfit.toFixed(2) : '',
                trade.volume,
                trade.riskPlanned.toFixed(2),
                trade.riskExecuted.toFixed(2),
                trade.riskDeviation.toFixed(2),
                trade.result.toFixed(2),
                trade.rPlanned.toFixed(2),
                trade.rExecuted.toFixed(2),
                trade.openTimeBRT,
                trade.duration || 'N/A',
                trade.item || '',
                trade.observation || '',
                trade.followedPlan ? 'Yes' : 'No',
                trade.brokeRules ? 'Yes' : 'No'
            ].join(',');

            document.getElementById('csv-output').textContent = csv;
        }

        // ==========================================
        // RESET PARSER
        // ==========================================
        function resetParser() {
            // Clear all forms
            document.getElementById('raw-data').value = '';
            document.getElementById('trade-form').reset();

            // Hide steps
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-4').classList.add('hidden');

            // Reset state
            detectedTrades = [];
            currentTrade = null;

            // Reset step indicator
            updateStepIndicator(1);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showMessage('Parser reiniciado', 'info');
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function updateStepIndicator(activeStep) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.querySelector(`.step-active, .step-completed, .step-inactive`);
                // This is simplified - in production you'd target each step individually
            }
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('status-message');

            messageEl.className = 'slide-in max-w-7xl mx-auto mt-4 px-4';

            let bgColor, textColor, borderColor;

            if (type === 'success') {
                bgColor = 'bg-green-50';
                textColor = 'text-green-800';
                borderColor = 'border-green-200';
            } else if (type === 'error') {
                bgColor = 'bg-red-50';
                textColor = 'text-red-800';
                borderColor = 'border-red-200';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-50';
                textColor = 'text-amber-800';
                borderColor = 'border-amber-200';
            } else {
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-800';
                borderColor = 'border-blue-200';
            }

            messageEl.innerHTML = `
        <div class="${bgColor} ${textColor} ${borderColor} border rounded-lg px-4 py-3 text-sm font-medium">
          ${text}
        </div>
      `;

            messageEl.classList.remove('hidden');

            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }

        function showFormError(text) {
            const errorEl = document.getElementById('form-error-message');

            errorEl.innerHTML = `
    <div class="bg-red-50 text-red-800 border-2 border-red-300 rounded-lg px-4 py-3 text-sm font-medium">
      <div class="flex items-start gap-3">
        <span class="text-xl">‚ùå</span>
        <div class="flex-1">
          <p class="font-bold mb-1">Error al guardar</p>
          <p>${text}</p>
        </div>
      </div>
    </div>
  `;

            errorEl.classList.remove('hidden');

            // Scroll to error (smooth)
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideFormError() {
            const errorEl = document.getElementById('form-error-message');
            errorEl.classList.add('hidden');
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Copiado al portapapeles', 'success');
            }).catch(err => {
                showMessage('‚ùå Error copiando: ' + err, 'error');
            });
        }

        // ==========================================
        // MOCK window.storage FOR DEVELOPMENT
        // ==========================================
        if (typeof window.storage === 'undefined') {
            console.warn('‚ö†Ô∏è window.storage not available. Using localStorage fallback.');

            window.storage = {
                async get(key) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value } : null;
                },
                async set(key, value) {
                    localStorage.setItem(key, value);
                    return { key, value };
                },
                async delete(key) {
                    localStorage.removeItem(key);
                    return { key, deleted: true };
                }
            };
        }
    </script>

</body>

</html>