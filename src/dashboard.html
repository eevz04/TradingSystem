<!DOCTYPE html>
<html lang="es" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Analytics Dashboard</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'navy-dark': '#1e3a5f',
                        'navy-medium': '#2c5282',
                        'blue-primary': '#3b82f6',
                        'blue-secondary': '#60a5fa',
                        'purple-primary': '#8b5cf6',
                    }
                }
            }
        }
    </script>

    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Custom scrollbar for dark mode */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: #0a0e17;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Custom scrollbar for light mode */
        [data-theme="light"] ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        [data-theme="light"] ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease,
                        border-color 0.2s ease,
                        color 0.2s ease,
                        transform 0.2s ease,
                        box-shadow 0.2s ease;
        }

        /* Glassmorphism base */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
        }

        [data-theme="light"] .glass {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        /* Sidebar styles */
        .sidebar-item {
            padding: 12px 16px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
            position: relative;
        }

        [data-theme="light"] .sidebar-item {
            color: rgba(0, 0, 0, 0.6);
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
            transform: translateX(2px);
        }

        [data-theme="light"] .sidebar-item:hover {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.9);
        }

        .sidebar-item.active {
            /* SIN gradiente azul/pÃºrpura - solo background sutil */
            background: rgba(255, 255, 255, 0.08) !important;
            background-image: none !important;
            color: rgba(255, 255, 255, 0.95);
            box-shadow: none !important;
            transform: translateX(0);
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        [data-theme="light"] .sidebar-item.active {
            background: rgba(0, 0, 0, 0.08) !important;
            background-image: none !important;
            color: rgba(0, 0, 0, 0.95);
            border-left: 2px solid rgba(0, 0, 0, 0.2);
        }

        /* Card hover effect */
        .card {
            transition: all 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
        }

        [data-theme="light"] .card:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        /* Sync status pulse */
        @keyframes pulse-dot {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .sync-pulse {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        /* Header glass effect */
        .header-glass {
            background: rgba(10, 14, 23, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        [data-theme="light"] .header-glass {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        /* Sidebar glass effect - CASI INVISIBLE (como CryptoJournal) */
        /* Eliminar TODOS los colores y gradientes del sidebar SOLO en el elemento sidebar */
        aside#sidebar,
        #sidebar,
        #sidebar.sidebar-glass,
        .sidebar-glass {
            background: rgba(255, 255, 255, 0.02) !important;
            background-color: rgba(255, 255, 255, 0.02) !important;
            background-image: none !important;
            border-right: 1px solid rgba(255, 255, 255, 0.06) !important;
            /* SIN blur para evitar difuminar colores del contenido */
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important;
            /* Asegurar que no hay colores de Tailwind */
            color: inherit !important;
        }

        /* Resetear sidebar en dark mode */
        [data-theme="dark"] aside#sidebar,
        [data-theme="dark"] #sidebar,
        [data-theme="dark"] #sidebar.sidebar-glass,
        [data-theme="dark"] .sidebar-glass {
            background: rgba(255, 255, 255, 0.02) !important;
            background-color: rgba(255, 255, 255, 0.02) !important;
            background-image: none !important;
            border-right: 1px solid rgba(255, 255, 255, 0.06) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important;
            color: inherit !important;
        }

        /* Resetear sidebar en light mode */
        [data-theme="light"] aside#sidebar,
        [data-theme="light"] #sidebar,
        [data-theme="light"] #sidebar.sidebar-glass,
        [data-theme="light"] .sidebar-glass {
            background: rgba(0, 0, 0, 0.02) !important;
            background-color: rgba(0, 0, 0, 0.02) !important;
            background-image: none !important;
            border-right: 1px solid rgba(0, 0, 0, 0.06) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important;
            color: inherit !important;
        }

        /* IMPORTANTE: El nav dentro del sidebar NO debe tener background */
        #sidebar > nav,
        aside#sidebar > nav {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
        }

        /* Typography */
        .title-main {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.6;
        }

        .label-text {
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .value-text {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
        }

        /* Placeholder icon */
        .placeholder-icon {
            width: 64px;
            height: 64px;
            opacity: 0.3;
            margin: 0 auto 16px;
        }

        /* Theme toggle button */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 8px 12px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.05);
        }

        [data-theme="light"] .theme-toggle {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        [data-theme="light"] .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        /* Sync badge */
        .sync-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 6px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: white;
        }

        /* Modal glass */
        .modal-glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        [data-theme="light"] .modal-glass {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        /* Light mode specific overrides */
        [data-theme="light"] body {
            background: #ffffff !important;
            color: #0f172a !important;
        }

        [data-theme="light"] main {
            background: #ffffff !important;
        }

        [data-theme="light"] h1,
        [data-theme="light"] h2,
        [data-theme="light"] h3 {
            color: #0f172a !important;
        }

        [data-theme="light"] .subtitle {
            color: #64748b !important;
        }

        [data-theme="light"] .placeholder-icon {
            opacity: 0.2;
        }

        [data-theme="light"] .sync-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        [data-theme="light"] .divider {
            border-color: rgba(0, 0, 0, 0.08) !important;
        }

        /* Auto theme text colors */
        [data-theme-text] {
            color: #f8fafc;
        }

        [data-theme="light"] [data-theme-text] {
            color: #0f172a !important;
        }

        [data-theme-subtitle] {
            color: rgba(255, 255, 255, 0.6);
        }

        [data-theme="light"] [data-theme-subtitle] {
            color: #64748b !important;
        }

        [data-theme-secondary] {
            color: #94a3b8;
        }

        [data-theme="light"] [data-theme-secondary] {
            color: #64748b !important;
        }

        /* Lucide icons color inheritance */
        [data-lucide][data-theme-text] {
            stroke: #f8fafc;
        }

        [data-theme="light"] [data-lucide][data-theme-text] {
            stroke: #0f172a !important;
        }

        [data-lucide][data-theme-secondary] {
            stroke: #94a3b8;
        }

        [data-theme="light"] [data-lucide][data-theme-secondary] {
            stroke: #64748b !important;
        }

        /* Monospace font for numbers */
        .font-mono {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
        }

        /* Table smooth transitions */
        table tbody tr {
            transition: background-color 0.15s ease, transform 0.15s ease;
            cursor: pointer;
        }

        table tbody tr:hover {
            transform: scale(1.001);
        }

        /* Expanded row styling */
        .expanded-row {
            background: transparent !important;
        }

        .expanded-row:hover {
            background: transparent !important;
        }

        .expanded-panel {
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal animations */
        #editModal {
            animation: fadeIn 0.2s ease-out;
        }

        #editModal > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Textarea styling */
        textarea {
            font-family: inherit;
        }

        textarea::placeholder {
            opacity: 0.4;
        }
    </style>
</head>

<body class="min-h-screen" id="body" style="background: #0a0e17; color: #f8fafc;">
    
    <!-- ============================================ -->
    <!-- HEADER (Fixed Top) -->
    <!-- ============================================ -->
    <header class="header-glass fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-6 py-4">
            <!-- Left: Logo & Title -->
            <div class="flex items-center gap-4">
                <h1 class="title-main" data-theme-text>Trading Analytics Dashboard</h1>
            </div>

            <!-- Right: Controls -->
            <div class="flex items-center gap-3">
                <!-- Sync Status -->
                <div class="sync-badge">
                    <i data-lucide="check-circle" class="w-4 h-4 sync-pulse"></i>
                    <span>Synced</span>
                </div>

                <!-- Dark/Light Mode Toggle -->
                <button 
                    id="theme-toggle"
                    class="theme-toggle"
                    title="Toggle Dark/Light Mode"
                >
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ============================================ -->
    <!-- MAIN LAYOUT -->
    <!-- ============================================ -->
    <div class="flex pt-16">
        
        <!-- ============================================ -->
        <!-- SIDEBAR (Fixed Left) -->
        <!-- ============================================ -->
        <aside 
            id="sidebar"
            class="sidebar-glass fixed left-0 top-16 bottom-0 w-[280px] overflow-y-auto hidden md:block"
            style="background: rgba(255, 255, 255, 0.02) !important; background-color: rgba(255, 255, 255, 0.02) !important; background-image: none !important;"
        >
            <nav class="p-6 space-y-2">
                <!-- Vista Tabla -->
                <button 
                    class="sidebar-item active w-full text-left flex items-center gap-3"
                    data-view="table"
                    onclick="switchView('table')"
                >
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Vista Tabla</span>
                </button>

                <!-- Vista Bloques -->
                <button 
                    class="sidebar-item w-full text-left flex items-center gap-3"
                    data-view="blocks"
                    onclick="switchView('blocks')"
                >
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    <span class="font-medium">Vista Bloques</span>
                </button>

                <!-- Vista Progreso -->
                <button 
                    class="sidebar-item w-full text-left flex items-center gap-3"
                    data-view="progress"
                    onclick="switchView('progress')"
                >
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span class="font-medium">Vista Progreso</span>
                </button>

                <!-- Vista Temporal -->
                <button 
                    class="sidebar-item w-full text-left flex items-center gap-3"
                    data-view="temporal"
                    onclick="switchView('temporal')"
                >
                    <i data-lucide="clock" class="w-5 h-5"></i>
                    <span class="font-medium">Vista Temporal</span>
                </button>

                <!-- Vista EV -->
                <button 
                    class="sidebar-item w-full text-left flex items-center gap-3"
                    data-view="ev"
                    onclick="switchView('ev')"
                >
                    <i data-lucide="dice-5" class="w-5 h-5"></i>
                    <span class="font-medium">Vista EV</span>
                </button>

                <!-- Divider -->
                <div class="my-4 border-t" style="border-color: rgba(255, 255, 255, 0.08);"></div>

                <!-- Config -->
                <button 
                    class="sidebar-item w-full text-left flex items-center gap-3"
                    onclick="openConfigModal()"
                >
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">ConfiguraciÃ³n</span>
                </button>
            </nav>
        </aside>

        <!-- ============================================ -->
        <!-- MAIN CONTENT -->
        <!-- ============================================ -->
        <main class="flex-1 md:ml-[280px] min-h-screen" style="background: #0a0e17;">
            
            <!-- Vista Tabla -->
            <div id="view-table" class="view-container p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h2 class="title-main mb-2" data-theme-text>Vista Tabla</h2>
                        <p class="subtitle" data-theme-subtitle>AnÃ¡lisis completo de todos tus trades</p>
                    </div>
                    <div class="glass card rounded-2xl p-12 border" style="min-height: 400px;">
                        <div class="flex flex-col items-center justify-center h-full">
                            <i data-lucide="bar-chart-3" class="placeholder-icon"></i>
                            <p class="text-center" data-theme-secondary style="font-size: 16px;">Tabla de trades - PrÃ³ximamente</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Bloques -->
            <div id="view-blocks" class="view-container hidden p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h2 class="title-main mb-2" data-theme-text>Vista Bloques</h2>
                        <p class="subtitle" data-theme-subtitle>AnÃ¡lisis por bloques de 10 trades</p>
                    </div>
                    <div class="glass card rounded-2xl p-12 border" style="min-height: 400px;">
                        <div class="flex flex-col items-center justify-center h-full">
                            <i data-lucide="layout-grid" class="placeholder-icon"></i>
                            <p class="text-center" data-theme-secondary style="font-size: 16px;">AnÃ¡lisis por bloques - PrÃ³ximamente</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Progreso -->
            <div id="view-progress" class="view-container hidden p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h2 class="title-main mb-2" data-theme-text>Vista Progreso</h2>
                        <p class="subtitle" data-theme-subtitle>Equity curve y progreso continuo</p>
                    </div>
                    <div class="glass card rounded-2xl p-12 border" style="min-height: 400px;">
                        <div class="flex flex-col items-center justify-center h-full">
                            <i data-lucide="trending-up" class="placeholder-icon"></i>
                            <p class="text-center" data-theme-secondary style="font-size: 16px;">Progreso continuo - PrÃ³ximamente</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista Temporal -->
            <div id="view-temporal" class="view-container hidden p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h2 class="title-main mb-2" data-theme-text>Vista Temporal</h2>
                        <p class="subtitle" data-theme-subtitle>Performance por hora y dÃ­a de semana</p>
                    </div>
                    <div class="glass card rounded-2xl p-12 border" style="min-height: 400px;">
                        <div class="flex flex-col items-center justify-center h-full">
                            <i data-lucide="clock" class="placeholder-icon"></i>
                            <p class="text-center" data-theme-secondary style="font-size: 16px;">AnÃ¡lisis temporal - PrÃ³ximamente</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista EV -->
            <div id="view-ev" class="view-container hidden p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h2 class="title-main mb-2" data-theme-text>Vista EV</h2>
                        <p class="subtitle" data-theme-subtitle>Expected Value y simulaciÃ³n Monte Carlo</p>
                    </div>
                    <div class="glass card rounded-2xl p-12 border" style="min-height: 400px;">
                        <div class="flex flex-col items-center justify-center h-full">
                            <i data-lucide="dice-5" class="placeholder-icon"></i>
                            <p class="text-center" data-theme-secondary style="font-size: 16px;">Expected Value y Monte Carlo - PrÃ³ximamente</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->

    <!-- Edit Trade Modal -->
    <div id="edit-trade-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
        <div class="modal-glass rounded-2xl shadow-2xl max-w-2xl w-full border">
            <div class="flex items-center justify-between p-6 border-b" style="border-color: rgba(255, 255, 255, 0.08);">
                <h3 class="text-xl font-bold" data-theme-text>Editar Trade</h3>
                <button 
                    onclick="closeEditTradeModal()"
                    class="transition-colors"
                    style="font-size: 24px; line-height: 1;"
                >
                    <i data-lucide="x" class="w-6 h-6" data-theme-secondary></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-center" data-theme-secondary>Formulario de ediciÃ³n - PrÃ³ximamente</p>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);">
        <div class="modal-glass rounded-2xl shadow-2xl max-w-3xl w-full border max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b" style="border-color: rgba(255, 255, 255, 0.08);">
                <div class="flex items-center gap-3">
                    <i data-lucide="settings" class="w-6 h-6" data-theme-text></i>
                    <h3 class="text-xl font-bold" data-theme-text>ConfiguraciÃ³n</h3>
                </div>
                <button 
                    onclick="closeConfigModal()"
                    class="transition-colors"
                    style="font-size: 24px; line-height: 1;"
                >
                    <i data-lucide="x" class="w-6 h-6" data-theme-secondary></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-center" data-theme-secondary>Panel de configuraciÃ³n - PrÃ³ximamente</p>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================ -->
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Storage Manager -->
    <script src="storage.js"></script>

    <script>
        // ==========================================
        // THEME MANAGEMENT
        // ==========================================
        function initTheme() {
            const savedTheme = localStorage.getItem('dashboard-theme') || 'dark';
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            const body = document.getElementById('body');
            const themeIcon = document.getElementById('theme-icon');
            const html = document.documentElement;
            const main = document.querySelector('main');
            
            // Set data-theme attribute on html element
            html.setAttribute('data-theme', theme);
            
            if (theme === 'dark') {
                body.style.background = '#0a0e17';
                body.style.color = '#f8fafc';
                if (main) main.style.background = '#0a0e17';
                // Update icon
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'moon');
                }
            } else {
                body.style.background = '#ffffff';
                body.style.color = '#0f172a';
                if (main) main.style.background = '#ffffff';
                // Update icon
                if (themeIcon) {
                    themeIcon.setAttribute('data-lucide', 'sun');
                }
            }
            
            localStorage.setItem('dashboard-theme', theme);
            
            // Update icon colors for Lucide icons
            updateIconColors(theme);
            
            // Reinitialize Lucide icons after theme change
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                    updateIconColors(theme);
                }
            }, 100);
        }

        function updateIconColors(theme) {
            const textColor = theme === 'dark' ? '#f8fafc' : '#0f172a';
            const secondaryColor = theme === 'dark' ? '#94a3b8' : '#64748b';
            
            // Update icons with data-theme-text
            document.querySelectorAll('[data-lucide][data-theme-text]').forEach(icon => {
                const svg = icon.querySelector('svg');
                if (svg) {
                    svg.style.stroke = textColor;
                }
            });
            
            // Update icons with data-theme-secondary
            document.querySelectorAll('[data-lucide][data-theme-secondary]').forEach(icon => {
                const svg = icon.querySelector('svg');
                if (svg) {
                    svg.style.stroke = secondaryColor;
                }
            });
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('dashboard-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        // ==========================================
        // VIEW SWITCHING
        // ==========================================
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.add('hidden');
            });

            // Show selected view
            const selectedView = document.getElementById(`view-${viewName}`);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeItem = document.querySelector(`[data-view="${viewName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // ==========================================
        // MODAL MANAGEMENT
        // ==========================================
        function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        function closeEditTradeModal() {
            document.getElementById('edit-trade-modal').classList.add('hidden');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Initialize theme
            initTheme();

            // Attach theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Close modals on outside click
            document.getElementById('config-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeConfigModal();
                }
            });

            document.getElementById('edit-trade-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditTradeModal();
                }
            });

            console.log('âœ… Dashboard initialized');
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DASHBOARD APP - Main Controller
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const DashboardApp = {
            trades: [],
            currentView: 'table',
            expandedTradeId: null,
            editingTradeId: null,
            equityCurveChart: null,

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // INITIALIZATION
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async init() {
                console.log('ğŸš€ Dashboard initializing...');

                try {
                    // Initialize StorageManager
                    await StorageManager.init();
                    console.log('âœ… StorageManager initialized');

                    // Load all trades
                    await this.loadTrades();

                    // Render current view
                    this.renderActiveView();

                    // Setup event listeners
                    this.setupEventListeners();

                    console.log('âœ… Dashboard ready');
                } catch (error) {
                    console.error('âŒ Dashboard initialization error:', error);
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // LOAD TRADES FROM STORAGE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async loadTrades() {
                console.log('ğŸ“Š Loading trades from storage...');

                const data = await StorageManager.getTrades();

                if (data && data.trades) {
                    // Filter out Quick Adds (incomplete trades)
                    this.trades = data.trades.filter(t => !t.isQuickAdd);

                    console.log(`âœ… Loaded ${this.trades.length} complete trades`);
                    console.log('Trades:', this.trades);
                } else {
                    this.trades = [];
                    console.log('âš ï¸ No trades found in storage');
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // CALCULATE METRICS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            calculateMetrics() {
                if (this.trades.length === 0) {
                    return null;
                }

                const totalTrades = this.trades.length;
                const winners = this.trades.filter(t => (t.pnl || t.result || 0) > 0);
                const losers = this.trades.filter(t => (t.pnl || t.result || 0) < 0);

                const winRate = totalTrades > 0 ? (winners.length / totalTrades * 100) : 0;

                const totalPnL = this.trades.reduce((sum, t) => {
                    return sum + (t.pnl || t.result || 0);
                }, 0);

                const avgR = this.trades.reduce((sum, t) => {
                    return sum + (t.rReal || t.rExecuted || 0);
                }, 0) / totalTrades;

                const totalWins = winners.reduce((sum, t) => sum + (t.pnl || t.result || 0), 0);
                const totalLosses = Math.abs(losers.reduce((sum, t) => sum + (t.pnl || t.result || 0), 0));
                const profitFactor = totalLosses > 0 ? (totalWins / totalLosses) : totalWins > 0 ? 999 : 0;

                const bestTrade = Math.max(...this.trades.map(t => t.pnl || t.result || 0));
                const worstTrade = Math.min(...this.trades.map(t => t.pnl || t.result || 0));

                // Current streak
                let currentStreak = 0;
                let streakType = '';
                for (let i = this.trades.length - 1; i >= 0; i--) {
                    const pnl = this.trades[i].pnl || this.trades[i].result || 0;
                    if (i === this.trades.length - 1) {
                        currentStreak = 1;
                        streakType = pnl > 0 ? 'W' : 'L';
                    } else {
                        const currentType = pnl > 0 ? 'W' : 'L';
                        if (currentType === streakType) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                }

                return {
                    totalTrades,
                    winRate,
                    totalPnL,
                    avgR,
                    profitFactor,
                    bestTrade,
                    worstTrade,
                    currentStreak: `${currentStreak}${streakType}`,
                    winners: winners.length,
                    losers: losers.length
                };
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RENDER EQUITY CURVE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderEquityCurve() {
                if (this.trades.length === 0) {
                    console.log('âš ï¸ No trades to render equity curve');
                    return;
                }

                console.log('ğŸ“ˆ Rendering equity curve...');

                // Destroy previous chart instance if exists
                if (this.equityCurveChart) {
                    this.equityCurveChart.destroy();
                    this.equityCurveChart = null;
                }

                // Sort trades by timestamp (oldest first)
                const sortedTrades = [...this.trades].sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.createdAt || 0);
                    const dateB = new Date(b.timestamp || b.createdAt || 0);
                    return dateA - dateB; // oldest first
                });

                // Calculate cumulative P&L
                let cumulativePnL = 0;
                const labels = [];
                const data = [];

                sortedTrades.forEach((trade, index) => {
                    const pnl = trade.pnl || trade.result || 0;
                    cumulativePnL += pnl;

                    // Label: Trade number
                    labels.push(`#${trade.tradeNumber || index + 1}`);
                    data.push(cumulativePnL);
                });

                // Get canvas element
                const canvas = document.getElementById('equityCurveChart');
                if (!canvas) {
                    console.error('âŒ Canvas element not found');
                    return;
                }

                const ctx = canvas.getContext('2d');

                // Determine line color based on final P&L
                const finalPnL = data[data.length - 1] || 0;
                const lineColor = finalPnL >= 0 ? 'rgb(52, 211, 153)' : 'rgb(248, 113, 113)'; // emerald-400 or red-400

                // Create chart
                this.equityCurveChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cumulative P&L',
                            data: data,
                            borderColor: lineColor,
                            backgroundColor: finalPnL >= 0
                                ? 'rgba(52, 211, 153, 0.1)'
                                : 'rgba(248, 113, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.4, // smooth curve
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            pointBackgroundColor: lineColor,
                            pointBorderColor: lineColor
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // no legend
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const sign = value >= 0 ? '+' : '';
                                        return `${sign}$${value.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)',
                                    callback: function(value) {
                                        const sign = value >= 0 ? '+' : '';
                                        return `${sign}$${value.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });

                console.log('âœ… Equity curve rendered');
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // EVENT LISTENERS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            setupEventListeners() {
                // Listen for storage changes (when new trades added from parser)
                window.addEventListener('storage', async (e) => {
                    if (e.key === 'trades-data') {
                        console.log('ğŸ”„ Storage changed, reloading trades...');
                        await this.loadTrades();
                        this.renderActiveView();
                    }
                });
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RENDER ACTIVE VIEW
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderActiveView() {
                const activeTab = document.querySelector('.sidebar-item.active');
                const viewId = activeTab?.getAttribute('data-view') || 'table';

                console.log(`ğŸ“Š Rendering view: ${viewId}`);
                this.currentView = viewId;

                switch(viewId) {
                    case 'table':
                        this.renderTableView();
                        break;
                    case 'blocks':
                    case 'progress':
                    case 'temporal':
                    case 'ev':
                        // Keep existing placeholder (coming soon)
                        console.log(`View ${viewId} - Placeholder shown`);
                        break;
                    default:
                        console.warn(`Unknown view: ${viewId}`);
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // TOGGLE EXPAND ROW
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            toggleExpandRow(tradeId) {
                console.log('ğŸ”„ Toggle expand for trade:', tradeId);

                if (this.expandedTradeId === tradeId) {
                    this.expandedTradeId = null; // Collapse
                } else {
                    this.expandedTradeId = tradeId; // Expand
                }

                this.renderTableView(); // Re-render table
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // OPEN EDIT MODAL
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            openEditModal(tradeId) {
                console.log('âœï¸ Opening edit modal for trade:', tradeId);

                // Find trade
                const trade = this.trades.find(t => t.tradeNumber === tradeId);
                if (!trade) {
                    console.error('Trade not found:', tradeId);
                    return;
                }

                this.editingTradeId = tradeId;

                // Populate modal with trade data
                document.getElementById('modalTradeNumber').textContent = `#${trade.tradeNumber}`;
                document.getElementById('modalSymbol').textContent = trade.symbol || '-';

                // Type badge
                const typeEl = document.getElementById('modalType');
                typeEl.textContent = trade.type || '-';
                typeEl.className = trade.type === 'LONG'
                    ? 'px-3 py-1 rounded-lg text-xs font-bold bg-emerald-500/15 text-emerald-400 border border-emerald-500/30'
                    : 'px-3 py-1 rounded-lg text-xs font-bold bg-red-500/15 text-red-400 border border-red-500/30';

                // P&L
                const pnl = trade.pnl || trade.result || 0;
                const pnlColor = pnl >= 0 ? 'text-emerald-400' : 'text-red-400';
                const pnlSign = pnl >= 0 ? '+' : '-';
                document.getElementById('modalPnL').textContent = `${pnlSign}${Math.abs(pnl).toFixed(2)}`;
                document.getElementById('modalPnL').className = `font-mono ${pnlColor}`;

                // Fill form fields
                document.getElementById('editObservation').value = trade.observation || '';
                document.getElementById('editWhatWentWell').value = trade.whatWentWell || '';
                document.getElementById('editWhatWentWrong').value = trade.whatWentWrong || '';
                document.getElementById('editFollowedPlan').checked = trade.followedPlan || false;

                // Show modal
                document.getElementById('editModal').classList.remove('hidden');

                // Re-init Lucide icons
                lucide.createIcons();
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // CLOSE EDIT MODAL
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            closeEditModal() {
                console.log('âŒ Closing edit modal');
                document.getElementById('editModal').classList.add('hidden');
                this.editingTradeId = null;
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // SAVE OBSERVATIONS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async saveObservations() {
                console.log('ğŸ’¾ Saving observations for trade:', this.editingTradeId);

                if (!this.editingTradeId) {
                    console.error('No trade selected for editing');
                    return;
                }

                // Get form values
                const observation = document.getElementById('editObservation').value.trim();
                const whatWentWell = document.getElementById('editWhatWentWell').value.trim();
                const whatWentWrong = document.getElementById('editWhatWentWrong').value.trim();
                const followedPlan = document.getElementById('editFollowedPlan').checked;

                // Update trade in memory
                const trade = this.trades.find(t => t.tradeNumber === this.editingTradeId);
                if (trade) {
                    trade.observation = observation;
                    trade.whatWentWell = whatWentWell;
                    trade.whatWentWrong = whatWentWrong;
                    trade.followedPlan = followedPlan;

                    console.log('Updated trade:', trade);
                }

                // Save to storage
                try {
                    const allData = await StorageManager.getTrades();

                    if (allData && allData.trades) {
                        // Find and update the trade in storage
                        const tradeIndex = allData.trades.findIndex(t => t.tradeNumber === this.editingTradeId);

                        if (tradeIndex !== -1) {
                            allData.trades[tradeIndex].observation = observation;
                            allData.trades[tradeIndex].whatWentWell = whatWentWell;
                            allData.trades[tradeIndex].whatWentWrong = whatWentWrong;
                            allData.trades[tradeIndex].followedPlan = followedPlan;

                            // Save back to storage
                            await StorageManager.setTrades(allData);

                            console.log('âœ… Observations saved to storage');

                            // Close modal
                            this.closeEditModal();

                            // Refresh table to show updated observations
                            this.renderTableView();
                        } else {
                            console.error('Trade not found in storage');
                        }
                    }
                } catch (error) {
                    console.error('âŒ Error saving observations:', error);
                    alert('Error al guardar. Por favor intenta de nuevo.');
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RENDER TABLE VIEW
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderTableView() {
                console.log('ğŸ“Š Rendering Vista Tabla with', this.trades.length, 'trades');

                const container = document.getElementById('view-table');

                if (!container) {
                    console.error('âŒ Container #view-table not found');
                    return;
                }

                // â”€â”€â”€ EMPTY STATE â”€â”€â”€
                if (this.trades.length === 0) {
                    container.innerHTML = `
                        <div class="max-w-7xl mx-auto">
                            <div class="mb-8">
                                <h2 class="title-main mb-2" data-theme-text>Vista Tabla</h2>
                                <p class="subtitle" data-theme-subtitle>AnÃ¡lisis completo de todos tus trades</p>
                            </div>
                            <div class="flex flex-col items-center justify-center py-20">
                                <i data-lucide="inbox" class="w-24 h-24 mb-6 opacity-20"></i>
                                <h3 class="text-3xl font-bold mb-3">No hay trades registrados</h3>
                                <p class="text-lg opacity-50 mb-8 text-center max-w-md">
                                    Comienza agregando tu primer trade desde el Parser
                                </p>
                                <a href="parser.html"
                                   class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-xl font-semibold transition-all shadow-lg hover:shadow-xl hover:scale-105">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                    Ir al Parser
                                </a>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // â”€â”€â”€ CALCULATE METRICS â”€â”€â”€
                const metrics = this.calculateMetrics();

                // â”€â”€â”€ BUILD METRICS CARDS HTML â”€â”€â”€
                const metricsHTML = metrics ? `
                    <!-- Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

                        <!-- Total Trades -->
                        <div class="rounded-xl p-6 border border-white/10"
                             style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-60 uppercase tracking-wide font-semibold">Total Trades</span>
                                <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-40"></i>
                            </div>
                            <div class="text-3xl font-bold">${metrics.totalTrades}</div>
                            <div class="text-xs opacity-50 mt-1">${metrics.winners}W / ${metrics.losers}L</div>
                        </div>

                        <!-- Win Rate -->
                        <div class="rounded-xl p-6 border border-white/10"
                             style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-60 uppercase tracking-wide font-semibold">Win Rate</span>
                                <i data-lucide="target" class="w-5 h-5 opacity-40"></i>
                            </div>
                            <div class="text-3xl font-bold ${metrics.winRate >= 50 ? 'text-emerald-400' : 'text-red-400'}">
                                ${metrics.winRate.toFixed(1)}%
                            </div>
                            <div class="text-xs opacity-50 mt-1">Target: 50%+</div>
                        </div>

                        <!-- Total P&L -->
                        <div class="rounded-xl p-6 border border-white/10"
                             style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-60 uppercase tracking-wide font-semibold">Total P&L</span>
                                <i data-lucide="dollar-sign" class="w-5 h-5 opacity-40"></i>
                            </div>
                            <div class="text-3xl font-bold font-mono ${metrics.totalPnL >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                                ${metrics.totalPnL >= 0 ? '+' : ''}${metrics.totalPnL.toFixed(2)}
                            </div>
                            <div class="text-xs opacity-50 mt-1">Net result</div>
                        </div>

                        <!-- Average R -->
                        <div class="rounded-xl p-6 border border-white/10"
                             style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm opacity-60 uppercase tracking-wide font-semibold">Average R</span>
                                <i data-lucide="trending-up" class="w-5 h-5 opacity-40"></i>
                            </div>
                            <div class="text-3xl font-bold font-mono ${metrics.avgR >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                                ${metrics.avgR >= 0 ? '+' : ''}${metrics.avgR.toFixed(2)}R
                            </div>
                            <div class="text-xs opacity-50 mt-1">Per trade</div>
                        </div>

                    </div>

                    <!-- Additional Metrics Row -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">

                        <div class="rounded-xl p-4 border border-white/10"
                             style="background: rgba(255,255,255,0.02); backdrop-filter: blur(12px);">
                            <div class="text-xs opacity-60 uppercase tracking-wide font-semibold mb-1">Profit Factor</div>
                            <div class="text-xl font-bold ${metrics.profitFactor >= 2 ? 'text-emerald-400' : metrics.profitFactor >= 1 ? 'text-blue-400' : 'text-red-400'}">
                                ${metrics.profitFactor < 999 ? metrics.profitFactor.toFixed(2) : 'âˆ'}
                            </div>
                        </div>

                        <div class="rounded-xl p-4 border border-white/10"
                             style="background: rgba(255,255,255,0.02); backdrop-filter: blur(12px);">
                            <div class="text-xs opacity-60 uppercase tracking-wide font-semibold mb-1">Best Trade</div>
                            <div class="text-xl font-bold text-emerald-400 font-mono">+${metrics.bestTrade.toFixed(2)}</div>
                        </div>

                        <div class="rounded-xl p-4 border border-white/10"
                             style="background: rgba(255,255,255,0.02); backdrop-filter: blur(12px);">
                            <div class="text-xs opacity-60 uppercase tracking-wide font-semibold mb-1">Worst Trade</div>
                            <div class="text-xl font-bold text-red-400 font-mono">-${Math.abs(metrics.worstTrade).toFixed(2)}</div>
                        </div>

                        <div class="rounded-xl p-4 border border-white/10"
                             style="background: rgba(255,255,255,0.02); backdrop-filter: blur(12px);">
                            <div class="text-xs opacity-60 uppercase tracking-wide font-semibold mb-1">Current Streak</div>
                            <div class="text-xl font-bold ${metrics.currentStreak.includes('W') ? 'text-emerald-400' : 'text-red-400'}">
                                ${metrics.currentStreak}
                            </div>
                        </div>

                    </div>
                ` : '';

                // â”€â”€â”€ EQUITY CURVE HTML â”€â”€â”€
                const equityCurveHTML = this.trades.length > 0 ? `
                    <!-- Equity Curve -->
                    <div class="rounded-2xl p-6 mb-6 border border-white/10"
                         style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">
                        <h3 class="text-xl font-bold mb-4">Equity Curve</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="equityCurveChart"></canvas>
                        </div>
                    </div>
                ` : '';

                // â”€â”€â”€ SORT TRADES (most recent first) â”€â”€â”€
                const sorted = [...this.trades].sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.createdAt || 0);
                    const dateB = new Date(b.timestamp || b.createdAt || 0);
                    return dateB - dateA;
                });

                console.log('Sorted trades (newest first):', sorted.length);

                // â”€â”€â”€ BUILD TABLE HTML â”€â”€â”€
                const tableHTML = `
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-8">
                            <h2 class="title-main mb-2" data-theme-text>Vista Tabla</h2>
                            <p class="subtitle" data-theme-subtitle>AnÃ¡lisis completo de todos tus trades</p>
                        </div>

                        <!-- Table Container -->
                        <div class="rounded-2xl overflow-hidden border border-white/10"
                             style="background: rgba(255,255,255,0.03); backdrop-filter: blur(12px);">

                            <!-- Table Header -->
                            <div class="px-6 py-5 border-b border-white/10">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-2xl font-bold">Historial de Trades</h3>
                                        <p class="text-sm opacity-50 mt-1">${sorted.length} trades registrados</p>
                                    </div>
                                    <a href="parser.html"
                                       class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-lg font-medium transition-all border border-blue-500/30">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Agregar Trade
                                    </a>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-white/10">
                                            <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">#</th>
                                            <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Symbol</th>
                                            <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Type</th>
                                            <th class="text-right py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Entry</th>
                                            <th class="text-right py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Exit</th>
                                            <th class="text-right py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Volume</th>
                                            <th class="text-right py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">Result</th>
                                            <th class="text-right py-4 px-6 text-xs font-bold uppercase tracking-wider opacity-60">R Real</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sorted.map(trade => this.renderTradeRow(trade)).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = metricsHTML + equityCurveHTML + tableHTML;

                // Reinitialize Lucide icons
                lucide.createIcons();

                // Render equity curve if we have trades
                if (this.trades.length > 0) {
                    // Need to wait for DOM to be ready
                    setTimeout(() => {
                        this.renderEquityCurve();
                    }, 100);
                }

                console.log(`âœ… Table rendered with ${sorted.length} trades`);
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RENDER SINGLE TRADE ROW
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderTradeRow(trade) {
                // Handle field name variations (parser legacy bugs)
                const pnl = trade.pnl || trade.result || 0;
                const rReal = trade.rReal || trade.rExecuted || 0;
                const exit = trade.exit || trade.exitPrice || 0;

                // Color coding
                const pnlColor = pnl >= 0 ? 'text-emerald-400' : 'text-red-400';
                const rColor = rReal >= 0 ? 'text-emerald-400' : 'text-red-400';
                const pnlSign = pnl >= 0 ? '+' : '-';
                const rSign = rReal >= 0 ? '+' : '-';

                // Type badge styling
                const typeBadge = trade.type === 'LONG'
                    ? 'bg-emerald-500/15 text-emerald-400 border-emerald-500/30'
                    : 'bg-red-500/15 text-red-400 border-red-500/30';

                // Check if this row is expanded
                const isExpanded = this.expandedTradeId === trade.tradeNumber;

                return `
                    <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-all duration-150 cursor-pointer group"
                        onclick="DashboardApp.toggleExpandRow(${trade.tradeNumber})"
                        data-trade-id="${trade.tradeNumber}">

                        <td class="py-4 px-6 text-sm font-bold group-hover:text-blue-400 transition-colors">
                            ${trade.tradeNumber || '-'}
                        </td>

                        <td class="py-4 px-6 text-sm font-bold">
                            ${trade.symbol || '-'}
                        </td>

                        <td class="py-4 px-6 text-sm">
                            <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border ${typeBadge}">
                                ${trade.type || '-'}
                            </span>
                        </td>

                        <td class="py-4 px-6 text-sm text-right font-mono opacity-80">
                            ${trade.entry ? trade.entry.toFixed(2) : '-'}
                        </td>

                        <td class="py-4 px-6 text-sm text-right font-mono opacity-80">
                            ${exit ? exit.toFixed(2) : '-'}
                        </td>

                        <td class="py-4 px-6 text-sm text-right font-mono opacity-80">
                            ${trade.volume || '-'}
                        </td>

                        <td class="py-4 px-6 text-sm text-right font-mono font-bold ${pnlColor}">
                            ${pnlSign}${Math.abs(pnl).toFixed(2)}
                        </td>

                        <td class="py-4 px-6 text-sm text-right font-mono font-bold ${rColor}">
                            ${rSign}${Math.abs(rReal).toFixed(2)}R
                        </td>
                    </tr>

                    ${isExpanded ? this.renderExpandedContent(trade) : ''}
                `;
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RENDER EXPANDED CONTENT
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderExpandedContent(trade) {
                return `
                    <tr class="expanded-row">
                        <td colspan="8" class="p-0">
                            <div class="expanded-panel" style="background: rgba(255,255,255,0.02); border-top: 1px solid rgba(255,255,255,0.05);">
                                <div class="p-6 space-y-4">

                                    <!-- Observaciones Generales -->
                                    ${trade.observation ? `
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <i data-lucide="message-square" class="w-4 h-4 opacity-60"></i>
                                                <h4 class="text-sm font-bold uppercase tracking-wide opacity-60">Observaciones</h4>
                                            </div>
                                            <p class="text-sm opacity-80 pl-6">${trade.observation}</p>
                                        </div>
                                    ` : ''}

                                    <!-- Lo que saliÃ³ bien -->
                                    ${trade.whatWentWell ? `
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
                                                <h4 class="text-sm font-bold uppercase tracking-wide text-emerald-400">Lo que saliÃ³ bien</h4>
                                            </div>
                                            <p class="text-sm opacity-80 pl-6">${trade.whatWentWell}</p>
                                        </div>
                                    ` : ''}

                                    <!-- Lo que saliÃ³ mal -->
                                    ${trade.whatWentWrong ? `
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
                                                <h4 class="text-sm font-bold uppercase tracking-wide text-red-400">Lo que saliÃ³ mal</h4>
                                            </div>
                                            <p class="text-sm opacity-80 pl-6">${trade.whatWentWrong}</p>
                                        </div>
                                    ` : ''}

                                    <!-- Reglas violadas -->
                                    ${trade.brokeRules && trade.rulesViolated?.length > 0 ? `
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-400"></i>
                                                <h4 class="text-sm font-bold uppercase tracking-wide text-amber-400">Reglas Violadas</h4>
                                            </div>
                                            <ul class="text-sm opacity-80 pl-6 list-disc list-inside">
                                                ${trade.rulesViolated.map(rule => `<li>${rule}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}

                                    <!-- BotÃ³n Editar -->
                                    <div class="pt-4 border-t border-white/5">
                                        <button onclick="event.stopPropagation(); DashboardApp.openEditModal(${trade.tradeNumber})"
                                                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-lg text-sm font-medium transition-all border border-blue-500/30">
                                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                                            Editar Observaciones
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZE APP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => DashboardApp.init());
        } else {
            DashboardApp.init();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UPDATE TAB SWITCHING TO TRIGGER RENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Wrap existing switchView function
        const originalSwitchView = window.switchView;
        if (originalSwitchView) {
            window.switchView = function(viewId) {
                // Call original function
                originalSwitchView(viewId);

                // Trigger render
                DashboardApp.currentView = viewId;
                DashboardApp.renderActiveView();
            };
        }
    </script>

    <!-- ============================================ -->
    <!-- EDIT OBSERVATIONS MODAL -->
    <!-- ============================================ -->

    <!-- Edit Observations Modal -->
    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);">
        <div class="relative w-full max-w-2xl rounded-2xl border border-white/10 p-6"
             style="background: rgba(10, 14, 23, 0.95); backdrop-filter: blur(20px);">

            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold">Editar Observaciones</h3>
                <button onclick="DashboardApp.closeEditModal()"
                        class="p-2 hover:bg-white/10 rounded-lg transition-all">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Trade Info -->
            <div class="mb-6 p-4 rounded-lg bg-white/5 border border-white/10">
                <div class="flex items-center gap-4 text-sm">
                    <span class="font-bold" id="modalTradeNumber">#1</span>
                    <span class="font-bold" id="modalSymbol">BTCUSD</span>
                    <span id="modalType" class="px-3 py-1 rounded-lg text-xs font-bold">LONG</span>
                    <span class="font-mono" id="modalPnL">+$100.00</span>
                </div>
            </div>

            <!-- Form -->
            <div class="space-y-4 mb-6">

                <!-- Observaciones Generales -->
                <div>
                    <label class="block text-sm font-semibold opacity-60 uppercase tracking-wide mb-2">
                        <i data-lucide="message-square" class="w-4 h-4 inline mr-2"></i>
                        Observaciones Generales
                    </label>
                    <textarea id="editObservation"
                              rows="3"
                              class="w-full px-4 py-3 rounded-lg bg-white/5 border border-white/10 focus:border-blue-500/50 focus:outline-none transition-all resize-none"
                              placeholder="Describe el trade en general..."></textarea>
                </div>

                <!-- Lo que saliÃ³ bien -->
                <div>
                    <label class="block text-sm font-semibold text-emerald-400 uppercase tracking-wide mb-2">
                        <i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>
                        Lo que saliÃ³ bien
                    </label>
                    <textarea id="editWhatWentWell"
                              rows="2"
                              class="w-full px-4 py-3 rounded-lg bg-white/5 border border-white/10 focus:border-emerald-500/50 focus:outline-none transition-all resize-none"
                              placeholder="Â¿QuÃ© hiciste correctamente?"></textarea>
                </div>

                <!-- Lo que saliÃ³ mal -->
                <div>
                    <label class="block text-sm font-semibold text-red-400 uppercase tracking-wide mb-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 inline mr-2"></i>
                        Lo que saliÃ³ mal
                    </label>
                    <textarea id="editWhatWentWrong"
                              rows="2"
                              class="w-full px-4 py-3 rounded-lg bg-white/5 border border-white/10 focus:border-red-500/50 focus:outline-none transition-all resize-none"
                              placeholder="Â¿QuÃ© podrÃ­as mejorar?"></textarea>
                </div>

                <!-- Plan Compliance -->
                <div class="flex items-center gap-3 p-4 rounded-lg bg-white/5 border border-white/10">
                    <input type="checkbox" id="editFollowedPlan"
                           class="w-5 h-5 rounded border-white/20 bg-white/5 checked:bg-blue-500 focus:ring-2 focus:ring-blue-500/50">
                    <label for="editFollowedPlan" class="text-sm font-semibold cursor-pointer">
                        SeguÃ­ el plan de trading
                    </label>
                </div>

            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-3">
                <button onclick="DashboardApp.closeEditModal()"
                        class="px-6 py-3 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 font-semibold transition-all">
                    Cancelar
                </button>
                <button onclick="DashboardApp.saveObservations()"
                        class="px-6 py-3 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 font-semibold transition-all shadow-lg">
                    Guardar Cambios
                </button>
            </div>

        </div>
    </div>

</body>

</html>
